---
title: "Tumorigenesis"
author: "Karsten Bach"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: journal
    highlight: tango
    code_folding: hide
---
***

- In this document I just have a first look at the data and check consistency with my previous findings, none of this will be part of the analysis

# Load Data
```{r, message=FALSE, fig.width=10, fig.height=5}
library(scran)
library(scater)
library(dplyr)
library(knitr)
library(ggplot2)
library(Rtsne)
library(cowplot)
library(Matrix)
library(viridis)
library(wesanderson)
library(DT)
source("functions.R")
theme_set(theme_cowplot())

# Load Data
sce <- readRDS("../data/combined_Robjects/SCE_final.rds")
sce <- sce[,sce$Condition!="CBLA2"]
colnames(sce) <- sce$barcode ### I have to fix this somewhere else
pD <- data.frame(colData(sce))
set.seed(42)
pD <- pD[sample(nrow(pD),nrow(pD)),]
umps <- read.csv("../data/combined_Robjects/UMAP_corrected.csv")[,-1]
pD <- left_join(pD,umps[,c("barcode","UMAP1Uncor","UMAP2Uncor")])
```

## Sample Overview

```{r, message=FALSE, fig.width=6, fig.height=3}
sumry <- group_by(pD, Batch, Age, Condition) %>%
    summarize(n=n())

sumry <- sumry[grepl("WKBR",sumry$Condition),]
timeplt <- ggplot(sumry, aes(x=as.numeric(Age), y=0)) +
    geom_segment(aes(x=25, y=0, xend=60, yend=0,
		     color=NULL),
                  arrow=arrow(length=unit(0.5, "cm"))) +
    geom_segment(aes(x=30, y=0.05, xend=30, yend=0,
		     color=NULL),
                  arrow=arrow(length=unit(0.3, "cm"))) +
    geom_dotplot(aes(fill=Batch, group=Batch), binwidth=1, 
		 stackgroups=TRUE, binpositions="all") +
    xlim(25,60) +
    ylim(0,.5) +
    scale_fill_manual(values=c("grey50","black"))  +
    xlab("Age") +
    ggtitle("Timepoints of Collection") +
    theme(axis.title.y=element_blank(),
	  axis.line.x=element_blank(),
	  axis.line.y=element_blank(),
	  axis.text.y=element_blank(),
	  legend.position="none",
	  axis.ticks.y=element_blank(),
	  axis.ticks.x=element_line(size=1, linetype="solid"),
	  axis.ticks.length.x=unit(.5,"cm"))
timeplt
```

# Batch Correction

```{r, message=FALSE, fig.width=10, fig.height=5}
p0 <- ggplot(pD, aes(x=UMAP1Uncor, y=UMAP2Uncor, color=Batch)) +
    geom_point() +
    ggtitle("Uncorrected") +
    scale_color_manual(values=c("grey50","black"))
p1 <- ggplot(pD, aes(x=UMAP1, y=UMAP2, color=Batch)) +
    geom_point() +
    ggtitle("Corrected") +
    scale_color_manual(values=c("grey50","black"))  
plot_grid(p0 + theme_void(), p1 + theme_void())
```

# Clustering
```{r, message=FALSE, fig.width=7, fig.height=7}
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=Groups)) +
    geom_point() +
    ggtitle("Groups") +
    scale_color_manual(values=wes_palette("Cavalcanti1",
					  length(unique(pD$Groups)),
					  type="continuous"))  +
    theme_void() 
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=CellTypes)) +
    geom_point() +
    ggtitle("Cluster") +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD$CellTypes)),type="continuous")) +
    theme_void() 
```

# Comparison to previous Clusters
- There is a good overlap with previously identified celltypes
```{r, message=FALSE, fig.width=7, fig.height=7}
celltypes <- read.csv("../data/firstBatch_Robjects/CellTypes.csv",stringsAsFactors=FALSE)[,-1]
colnames(celltypes)[2:6] <- paste0("Old_",colnames(celltypes)[2:6])
pD <- left_join(pD,celltypes[,c("barcode","Old_CellType","Old_MajorGroups","Old_Groups")])
pD$CellType[is.na(pD$Old_CellType)] <- "New"
pD$MajorGroups[is.na(pD$Old_MajorGroups)] <- "New"
pD$Groups[is.na(pD$Old_Groups)] <- "New"
```

### Cells from "previous clusters" cluster together

```{r, message=FALSE, fig.width=10, fig.height=5}
ctypes <- group_by(filter(pD,MajorGroups!="New"), CellTypes, Old_CellType ) %>%
    summarize(n=n()) %>%
    mutate(frac=n/sum(n)) %>%
    ungroup() %>%
    ggplot(.,aes(x=CellTypes, y=frac, fill=Old_CellType)) +
    geom_bar(stat="identity") +
    scale_fill_manual(values=wes_palette("FantasticFox1",length(unique(pD$Old_CellType)),type="continuous")) 
ctypes
```

### Confusion Matrix

```{r, message=FALSE, fig.width=8, fig.height=8}
pD.sub <- pD[pD$Old_MajorGroups!="New",]

conf <- as.matrix(table(pD.sub$CellTypes,pD.sub$Old_CellType))
conf <- t(t(conf)/colSums(conf))
library(pheatmap)
pheatmap(conf,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE)
```


### Pseudotumor time trajectory
```{r, message=FALSE, fig.width=10, fig.height=5}
#Subset
cells <- sce$barcode[sce$MajorGroups %in% "Epithelial"]

#Sum across conditions 
sce.sub <- sce[,cells]
sce.sum <- aggregateAcrossCells(sce.sub,
			  id=DataFrame(Condition=sce.sub$Condition))

library(edgeR)
y <- DGEList(counts=counts(sce.sum),samples=colData(sce.sum))
keep <- filterByExpr(y, group=y$samples$Condition)
y <- y[keep,]
y <- calcNormFactors(y)
logcpm <- cpm(y,log=TRUE)
# 
cor.logcpm <- removeBatchEffect(logcpm, batch=y$samples$Batch)
#
pcs <- prcomp(t(cor.logcpm))
pca <- data.frame(pcs$x)
pca[,"Condition"] <- y$samples$Condition
pca$Age <- y$samples$Age
pca$Batch <- y$samples$Batch
rownames(pca) <- pca$Condition

vars <- apply(pcs$x,2,var)
rel.vars <- round(vars/sum(vars)*100,1)
# 
library(ggrepel)
ggplot(pca, aes(x=PC1, y=PC2, color=Age,label=Condition,shape=Batch)) +
    geom_text_repel(size=3) +
    geom_point(size=2) +
    xlab(paste0("PC1(",rel.vars["PC1"],"%)")) +
    ylab(paste0("PC2(",rel.vars["PC2"],"%)")) 

```

```{r, message=FALSE, fig.width=10, fig.height=5}
sumry <- arrange(sumry,Age)
sumry$Condition <- factor(sumry$Condition,
			  levels=sumry$Condition)
cols <- data.frame(Age=unique(sumry$Age))
cols$cols <- plasma(nrow(cols),begin=1,end=0)

sumry <- left_join(sumry,cols)

timeplt_byCond <- ggplot(sumry, aes(x=as.numeric(Age), y=0)) +
    geom_segment(aes(x=25, y=0, xend=60, yend=0,
		     color=NULL),
                  arrow=arrow(length=unit(0.5, "cm"))) +
    geom_segment(aes(x=30, y=0.05, xend=30, yend=0,
		     color=NULL),
                  arrow=arrow(length=unit(0.3, "cm"))) +
    geom_dotplot(aes(fill=Condition, group=Condition), binwidth=1, 
		 stackgroups=TRUE, binpositions="all") +
    xlim(25,60) +
    ylim(0,.5) +
    xlab("Age") +
    scale_fill_manual(values=sumry$cols) +
    ggtitle("Timepoints of Collection") +
    theme(axis.title.y=element_blank(),
	  axis.line.x=element_blank(),
	  axis.line.y=element_blank(),
	  axis.text.y=element_blank(),
	  legend.position="none",
	  axis.ticks.y=element_blank(),
	  axis.ticks.x=element_line(size=1, linetype="solid"),
	  axis.ticks.length.x=unit(.5,"cm"))

pca$ptime <- (pca$PC1-min(pca$PC1))/max(pca$PC1-min(pca$PC1)) * 100

sumry <- left_join(sumry,pca[,c("Condition","ptime")])
sumry$Condition <- factor(sumry$Condition,
			  levels=sumry$Condition)
pseudotimeplt_byCond <- ggplot(sumry, aes(x=ptime, y=0)) +
    geom_segment(aes(x=0, y=0, xend=110, yend=0,
		     color=NULL),
                  arrow=arrow(length=unit(0.5, "cm"))) +
    geom_dotplot(aes(fill=Condition, group=Condition), binwidth=1, 
		 stackgroups=TRUE, binpositions="all", dotsize=2) +
    xlim(0,110) +
    ylim(0,.5) +
    xlab("Pseudotime") +
    scale_fill_manual(values=sumry$cols) +
    ggtitle("Inferred Order") +
    theme(axis.title.y=element_blank(),
	  axis.line.x=element_blank(),
	  axis.line.y=element_blank(),
	  axis.text.y=element_blank(),
	  legend.position="none",
	  axis.ticks.y=element_blank(),
	  axis.ticks.x=element_line(size=1, linetype="solid"),
	  axis.ticks.length.x=unit(.5,"cm"))

timeplt_byCond
pseudotimeplt_byCond
```
