---
title: "Tumorigenesis Sanity Check"
author: "Karsten Bach"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: journal
    highlight: tango
    code_folding: hide
---
***

- In this document I just have a first look at the data and check consistency with my previous findings, none of this will be part of the analysis

# Data before and after correction
```{r, message=FALSE, fig.width=10, fig.height=5}
library(scran)
library(scater)
library(dplyr)
library(knitr)
library(ggplot2)
library(Rtsne)
library(cowplot)
library(Matrix)
library(viridis)
library(wesanderson)
library(DT)
source("functions.R")

# Load Data
dataList <- readRDS("../data/combined_Robjects/ExpressionList_QC_norm.rds")
m <- dataList[["counts"]]
pD <- dataList[["phenoData"]]
rownames(pD) <- pD$barcode
fD <- dataList[["featureData"]]
rm(dataList)

ump <- read.csv("../data/combined_Robjects/UMAP_corrected.csv",row.names=1,stringsAsFactor=FALSE)
pD <- pD[ump$barcode,]
pD <- left_join(pD,ump)
```

## Comparison to correction
- The data after batch correction looks better, however the different populations appear closer to each other?
```{r, message=FALSE, fig.width=10, fig.height=5}
p0 <- ggplot(pD, aes(x=UMAP1Uncor, y=UMAP2Uncor, fill=Batch)) +
    geom_point(pch=21,size=0.9)  +
    scale_fill_brewer(palette="Set1")
p1 <- ggplot(pD, aes(x=UMAP1, y=UMAP2,fill=Batch)) +
    geom_point(pch=21,size=0.9) +
    scale_fill_brewer(palette="Set1")
plot_grid(p0,p1)

pD.sub <- pD[pD$Condition %in% c("CBLT","CBLA1","CBLA2"),]
p0 <- ggplot(pD.sub, aes(x=UMAP1Uncor, y=UMAP2Uncor, fill=Batch)) +
    geom_point(pch=21,size=0.8)  +
    scale_fill_brewer(palette="Set1") +
    ggtitle("Only CBLA")
p1 <- ggplot(pD.sub, aes(x=UMAP1, y=UMAP2,fill=Batch)) +
    geom_point(pch=21,size=0.8) +
    scale_fill_brewer(palette="Set1") +
    ggtitle("Only CBLA")
plot_grid(p0,p1)
```

## Clustering
```{r, message=FALSE, fig.width=12, fig.height=12}
anno <- read.csv("../data/combined_Robjects/SubClusters.csv",stringsAsFactors=FALSE)[,-1]
pD <- left_join(pD,anno)
pD$Cluster <- factor(pD$Cluster)
pD$SCID <- factor(pD$SCID)
pD$UnmergedID <- factor(pD$UnmergedID)
pD$MajorCluster <- factor(pD$MajorCluster)

ggplot(pD, aes(x=UMAP1, y=UMAP2, color=Cluster)) +
    geom_point() +
    ggtitle("Cluster") +
    theme_void() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD$Cluster)),type="continuous")) +
    facet_wrap(~MajorCluster)
```

## Clustering
- I subclustered clusters with more than 100 cells, while requiring at least 15 DE genes between the subclusters
- This appears to resolve some further strucutres for some of the clusters
```{r, message=FALSE, fig.width=14, fig.height=14}
pD.sub <- pD[!is.na(pD$SubUMAP1),]
ggplot(pD.sub, aes(x=SubUMAP1, y=SubUMAP2, color=UnmergedID)) +
    geom_point() +
    ggtitle("Cluster") +
    facet_wrap(~MajorCluster,scales="free") +
    theme_void() +
    ggtitle("Unmerged Clusters")
ggplot(pD.sub, aes(x=SubUMAP1, y=SubUMAP2, color=SCID)) +
    geom_point() +
    ggtitle("Cluster") +
    facet_wrap(~MajorCluster,scales="free") +
    theme_void() +
    ggtitle("After merging Clusters w less than 15DE")
```

## Comparison to previous cell types
- There is a fairly good overlap with previously identified celltypes
```{r, message=FALSE, fig.width=7, fig.height=7}
celltypes <- read.csv("../data/firstBatch_Robjects/CellTypes.csv",stringsAsFactors=FALSE)
pD <- left_join(pD,celltypes[,c("barcode","CellType","MajorGroups","Groups")])
pD$CellType[is.na(pD$CellType)] <- "Undetermined"
pD$MajorGroups[is.na(pD$MajorGroups)] <- "Undetermined"
pD$Groups[is.na(pD$Groups)] <- "Undetermined"

p1 <- ggplot(pD, aes(x=UMAP1, y=UMAP2,color=MajorGroups)) +
    geom_point(size=1) +
    scale_color_brewer(palette="Set1")
p1
```

```{r, message=FALSE, fig.width=10, fig.height=5}
celltypes <- read.csv("../data/firstBatch_Robjects/CellTypes.csv",stringsAsFactors=FALSE)
grps <- group_by(filter(pD,MajorGroups!="Undetermined"), Cluster, Groups) %>%
    summarize(n=n()) %>%
    mutate(frac=n/sum(n)) %>%
    ungroup() %>%
    ggplot(.,aes(x=Cluster, y=frac, fill=Groups)) +
    geom_bar(stat="identity") 

ctypes <- group_by(filter(pD,MajorGroups!="Undetermined"), Cluster, CellType ) %>%
    summarize(n=n()) %>%
    mutate(frac=n/sum(n)) %>%
    ungroup() %>%
    ggplot(.,aes(x=Cluster, y=frac, fill=CellType)) +
    geom_bar(stat="identity") 

grps
ctypes

```

### In more depth

- A better way to visualize this is as confusion matrix between the previous 
  classification and the new one (where I ignore the cells from batch2)
- It is reassuring to see that almost all clusters are dominated by one previous celltype
- Rows with multiple red spots (or none) indicate cell types that have now been split in multiple clusters
- Columns with multiple high values correspond to clusters that now incorporate multiple cell types
- Couple of observations:
    - Vascular epithelial cells are bunched in one cluster, which is useful
    - Some of the fibroblast clusters are collapsed in fewer clusters which is also useful
    - Caf1 is lost?
    - Caf2/3 now in one Cluster 
    - Cluster 2 is a mess
    - mDC no longer a seperate cluster?
    - Dc209 now split in 3
    - __Av is split__
    - This is without merging clusters after DE min 10
    - The pre correction outliers are all in cluster 39 (see below) basophils (Bp)

```{r, message=FALSE, fig.width=8, fig.height=8}
pD.sub <- pD[pD$MajorGroups!="Undetermined",]

conf <- as.matrix(table(pD.sub$CellType,pD.sub$Cluster))
conf <- t(t(conf)/colSums(conf))
library(pheatmap)
pheatmap(conf,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE)
```


### Can we still do the pseudotumor time trajectory?
- It's not looking great but also not awful
- the code below if subset to batch 1 reproduces previous result
- with batch 2 the ordering still makes sense but the two CBLAs are a bit funny.. have to check that
- might be an issue of cell type definition as this isn't done properly here
```{r, message=FALSE, fig.width=10, fig.height=5}
m.raw <- readRDS("../data/combined_Robjects/CountMatrix.rds")
conf <- as.matrix(table(pD$Groups,pD$Cluster))
conf <- t(t(conf)/colSums(conf))
myeloid.clusters <- colnames(conf)[conf["Myeloid",]>0.2]
myeloid.clusters <- myeloid.clusters[!is.na(myeloid.clusters)]
myeloid.cells <- pD$barcode[pD$Cluster %in% myeloid.clusters]

rownames(pD) <- pD$barcode
pD.sub <- pD[myeloid.cells,]
m.sub <- m.raw[,myeloid.cells]
# m.sub <- m.sub[rowMeans(m.sub)>0.01,]



out <- data.frame(numeric(nrow(m.sub)))
colnames(out) <- levels(factor(pD.sub$Condition))[1]
for (cond in levels(factor(pD.sub$Condition))) {
    expr <- rowMeans(m.sub[,pD.sub$Condition==cond])
    colname <- cond
    out[,colname] <- expr
}
rownames(out) <- rownames(m.sub)
out <- out[rowSums(out)>0,]

library(edgeR)
y <- DGEList(counts=out)
y <- calcNormFactors(y)
out <- cpm(y,log=TRUE)

pcs <- prcomp(t(out))
pca <- data.frame(pcs$x)
pca[,"Condition"] <- colnames(out)
ages <- pD[!duplicated(pD$Condition),c("Condition","Age","Batch")]
pca <- left_join(pca, ages)
rownames(pca) <- pca$Condition

library(ggrepel)
ggplot(pca, aes(x=PC1, y=PC2, color=Age,label=Condition,shape=Batch)) +
    geom_text_repel(size=3) +
    geom_point(size=2)
```
