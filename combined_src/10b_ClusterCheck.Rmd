---
title: "Clustering Check"
author: "Karsten Bach"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: journal
    highlight: tango
    code_folding: hide
---
***


# Load Data
```{r, message=FALSE, warning=FALSE}
# Clustering
library(igraph)
library(scran)
# library(umap)
library(ggplot2)
library(cowplot)
library(Matrix)
source("functions.R")
theme_set(theme_cowplot())

# Load Data

sce <- readRDS("../data/combined_Robjects/SCE_QC_norm.rds")
ump <- read.csv("../data/combined_Robjects/UMAP_corrected.csv",stringsAsFactors=FALSE)[,-1]
sce <- sce[,ump$barcode] # this ensure the right order and cells for the umap graph below

# Graph

umapgraph <- readRDS("../data/combined_Robjects/UMAP_graphs.rds")
igr.cor <- umapgraph[["Corrected"]]

# Cluster Output

clustr <- read.csv("../data/combined_Robjects/Compare_Clusters.csv", stringsAsFactors=FALSE)[,-1]

# Combine
library(dplyr)
pD <- data.frame(colData(sce))
pD <- left_join(pD,clustr)
pD <- left_join(pD,ump)

```

# Comparison
There are mutliple ways to compare the different clustering methods.
Truth is, there is no way to define a "best" result.
Yet, we can get a feelign of how fine they resolve and whether or not "it seems sensible".
Below I will explore the following criteria to make that judgement.

- Simple structure in UMAP
  + Do all structures seem resolved
  + Are some structure overclustered?
- Cluster modularity
  + Again look at resolution
- Concordance with previous annotation
  + Compare to batch 1 clustering results


## UMAP

### Walktrap 3 clustering
```{r, message=FALSE, warning=FALSE, fig.width=9, fig.height=9}
library(wesanderson)
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=Walktrap3)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD$Walktrap3)),type="continuous")) 
```

```{r, message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
library(wesanderson)
ggplot(pD, aes(x=UMAP1, y=UMAP2)) +
    geom_point() +
    facet_wrap(~Walktrap3)
```

### Walktrap 4 clustering
```{r, message=FALSE, warning=FALSE, fig.width=9, fig.height=9}
library(wesanderson)
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=Walktrap4)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD$Walktrap4)),type="continuous")) 
```

```{r, message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
library(wesanderson)
ggplot(pD, aes(x=UMAP1, y=UMAP2)) +
    geom_point() +
    facet_wrap(~Walktrap4)
```

### Walktrap 5
```{r, message=FALSE, warning=FALSE, fig.width=9, fig.height=9}
library(wesanderson)
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=Walktrap5)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD$Walktrap5)),type="continuous")) 
```

```{r, message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
library(wesanderson)
ggplot(pD, aes(x=UMAP1, y=UMAP2)) +
    geom_point() +
    facet_wrap(~Walktrap5)
```

## Cluster Modularity

### UMAP Walktrap clustering
```{r, message=FALSE, warning=FALSE, fig.width=9, fig.height=9, cache=TRUE}
# ratio <- clusterModularity(igr.cor, pD$Walktrap3, as.ratio=TRUE)
# library(pheatmap)
# pheatmap(log2(ratio+1), cluster_rows=FALSE, cluster_cols=FALSE,
#          color=colorRampPalette(c("white", "blue"))(100))
```

### SNN Walktrap clustering
```{r, message=FALSE, warning=FALSE, fig.width=9, fig.height=9, cache=TRUE}
# ratio <- clusterModularity(snn, pD$Walktrap4, as.ratio=TRUE)
# library(pheatmap)
# pheatmap(log2(ratio+1), cluster_rows=FALSE, cluster_cols=FALSE,
#          color=colorRampPalette(c("white", "blue"))(100))
```

### SNN Louvain clustering
```{r, message=FALSE, warning=FALSE, fig.width=9, fig.height=9, cache=TRUE}
# ratio <- clusterModularity(snn, pD$Walktrap5, as.ratio=TRUE)
# library(pheatmap)
# pheatmap(log2(ratio+1), cluster_rows=FALSE, cluster_cols=FALSE,
#          color=colorRampPalette(c("white", "blue"))(100))
```

## Concordance with previous annotation

### Visualisation of previous annotation in UMAP
I am only plotting cells from Batch 1
```{r, message=FALSE, fig.width=7, fig.height=7}
celltypes <- read.csv("../data/firstBatch_Robjects/CellTypes.csv",stringsAsFactors=FALSE)
pD <- left_join(pD,celltypes[,c("barcode","CellType","MajorGroups","Groups")])
pD$CellType[is.na(pD$CellType)] <- "Undetermined"
pD$MajorGroups[is.na(pD$MajorGroups)] <- "Undetermined"
pD$Groups[is.na(pD$Groups)] <- "Undetermined"

p1 <- ggplot(pD[pD$Groups!="Undetermined",], aes(x=UMAP1, y=UMAP2,color=MajorGroups)) +
    geom_point(size=1) +
    scale_color_brewer(palette="Set1")
p1

p2 <- ggplot(pD[pD$Groups!="Undetermined",], aes(x=UMAP1, y=UMAP2,color=CellType)) +
    geom_point(size=1) +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD$CellType)),type="continuous")) 
p2
```

### Comparison to UMAP Walktrap

```{r, message=FALSE, fig.width=8, fig.height=8}
pD.sub <- pD[pD$MajorGroups!="Undetermined",]

conf <- as.matrix(table(pD.sub$CellType,pD.sub$Walktrap3))
conf <- t(t(conf)/colSums(conf))
library(pheatmap)
pheatmap(conf,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE)
```

### Comparison to SNN Walktrap

```{r, message=FALSE, fig.width=8, fig.height=8}
pD.sub <- pD[pD$MajorGroups!="Undetermined",]

conf <- as.matrix(table(pD.sub$CellType,pD.sub$Walktrap4))
conf <- t(t(conf)/colSums(conf))
library(pheatmap)
pheatmap(conf,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE)
```

### Comparison to SNN Louvain

```{r, message=FALSE, fig.width=8, fig.height=8}
pD.sub <- pD[pD$MajorGroups!="Undetermined",]

conf <- as.matrix(table(pD$Walktrap3,pD$Walktrap4))
conf <- t(t(conf)/colSums(conf))
library(pheatmap)
pheatmap(conf,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE)
```

## Detailed Comparison of Myeloid
### UMAP Walktrap
```{r, message=FALSE, fig.width=8, fig.height=8}
pD.my <- pD[pD$UMAP1>0 & pD$UMAP1<5 & pD$UMAP2<10 & pD$UMAP2>4,]
pD.my.sub <- pD.my[pD.my$CellType!="Undetermined",]
pD.my <- droplevels(pD.my)

p0 <- ggplot(pD.my, aes(x=UMAP1, y=UMAP2, color=Walktrap3)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my$Walktrap3)),type="continuous")) 

p1 <- ggplot(pD.my.sub, aes(x=UMAP1, y=UMAP2, color=CellType)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my.sub$CellType)),type="continuous")) 
plot_grid(p0,p1)
```

### SNN Walktrap
```{r, message=FALSE, fig.width=8, fig.height=8}
p0 <- ggplot(pD.my, aes(x=UMAP1, y=UMAP2, color=Walktrap4)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my$Walktrap4)),type="continuous")) 

p1 <- ggplot(pD.my.sub, aes(x=UMAP1, y=UMAP2, color=CellType)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my.sub$CellType)),type="continuous")) 
plot_grid(p0,p1)
```

### SNN Louvain
```{r, message=FALSE, fig.width=8, fig.height=8}
p0 <- ggplot(pD.my, aes(x=UMAP1, y=UMAP2, color=Walktrap5)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my$Walktrap5)),type="continuous")) 

p1 <- ggplot(pD.my.sub, aes(x=UMAP1, y=UMAP2, color=CellType)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my.sub$CellType)),type="continuous")) 
plot_grid(p0,p1)
```

## Detailed Comparison of ERneg
### UMAP Walktrap
```{r, message=FALSE, fig.width=8, fig.height=8}
pD.my <- pD[pD$UMAP1>3 & pD$UMAP1<8 & pD$UMAP2<4 & pD$UMAP2>-5,]
pD.my.sub <- pD.my[pD.my$CellType!="Undetermined",]
pD.my <- droplevels(pD.my)

p0 <- ggplot(pD.my, aes(x=UMAP1, y=UMAP2, color=Walktrap3)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my$Walktrap3)),type="continuous")) 

p1 <- ggplot(pD.my.sub, aes(x=UMAP1, y=UMAP2, color=CellType)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my.sub$CellType)),type="continuous")) 
plot_grid(p0,p1)
```

### SNN Walktrap
```{r, message=FALSE, fig.width=8, fig.height=8}
p0 <- ggplot(pD.my, aes(x=UMAP1, y=UMAP2, color=Walktrap4)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my$Walktrap4)),type="continuous")) 

p1 <- ggplot(pD.my.sub, aes(x=UMAP1, y=UMAP2, color=CellType)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my.sub$CellType)),type="continuous")) 
plot_grid(p0,p1)
```

### SNN Louvain
```{r, message=FALSE, fig.width=8, fig.height=8}
p0 <- ggplot(pD.my, aes(x=UMAP1, y=UMAP2, color=Walktrap5)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my$Walktrap5)),type="continuous")) 

p1 <- ggplot(pD.my.sub, aes(x=UMAP1, y=UMAP2, color=CellType)) +
    geom_point() +
    scale_color_manual(values=wes_palette("FantasticFox1",length(unique(pD.my.sub$CellType)),type="continuous")) 
plot_grid(p0,p1)
```
