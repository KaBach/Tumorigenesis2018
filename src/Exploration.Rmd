---
title: "BRCA1 first look"
author: "Karsten Bach"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: united
    highlight: tango
---
***

# Load Data
```{r, message=FALSE}
library(scran)
library(scater)
library(dplyr)
library(knitr)
library(ggplot2)
library(Rtsne)
library(cowplot)
library(Matrix)
library(gridExtra)
source("functions.R")

# Load Data
dataList <- readRDS("../data/Robjects/ExpressionList_QC.rds")
sfs <- read.csv("../data/Robjects/SizeFactors.csv")
m <- dataList[["counts"]]
pD <- dataList[["phenoData"]]
pD <- left_join(pD,sfs)
fD <- dataList[["featureData"]]
rm(dataList)
```

# Number of Cells
We sequenced a total of `r ncol(m)` cells.
```{r}
kable(t(as.matrix(table(pD$Condition))))
```

# Most of the variation in cell number is between biological replicates
```{r}
fp <- group_by(pD[!pD$AnimalHadTumor,], SampleID) %>%
    summarize(Number=n())
fp$Condition <- as.factor(substring(fp$SampleID,1,nchar(fp$SampleID)-1))
ggplot(fp, aes(x=Condition, y=Number)) +
    geom_point()
```

# Quality Control
```{r, fig.width=12, fig.height=12}
filt.gd1 <- min(pD$GenesDetected[pD$PassAll])
filt.gd2 <- max(pD$GenesDetected[pD$PassAll])
filt.lb1 <- min(pD$UmiSums[pD$PassAll])
filt.lb2 <- max(pD$UmiSums[pD$PassAll])
filt.mt <- max(pD$prcntMito[pD$PassAll])

# Quality Control
# Sequencing Depth and Genes detected
genesDetected <- ggplot(pD, aes(x=SampleID,y=GenesDetected,fill=Condition)) +
    geom_violin(draw_quantiles=0.5)+
    scale_y_log10() +
    ylab("Total number of genes detected") +
    xlab("") +
    geom_hline(yintercept=filt.gd1,lty="dashed",color="red") +
    geom_hline(yintercept=filt.gd2,lty="dashed",color="red") +
    scale_fill_brewer(palette="Dark2") +
    theme_bw() +
    theme(legend.position="none") +
    coord_flip()

LibrarySize <- ggplot(pD, aes(x=SampleID,y=UmiSums,fill=Condition)) +
    geom_violin(draw_quantiles=0.5)+
    scale_y_log10() +
    ylab("Total number of molecules") +
    xlab("") +
    geom_hline(yintercept=filt.lb1,lty="dashed",color="red") +
    geom_hline(yintercept=filt.lb2,lty="dashed",color="red") +
    scale_fill_brewer(palette="Dark2") +
    theme_bw() +
    theme(legend.position="none") +
    coord_flip()

cellViability <- ggplot(pD, aes(x=SampleID,y=prcntMito,fill=Condition)) +
    geom_violin(draw_quantiles=0.5)+
    ylab("Percentage of mitochondrial molecules") +
    xlab("") +
    geom_hline(yintercept=filt.mt,lty="dashed",color="red") +
    scale_fill_brewer(palette="Dark2") +
    theme_bw() +
    coord_flip()

sumry <- group_by(pD, SampleID) %>%
    summarize("# Before QC"=n(),
	      "Total molecules"=median(UmiSums),
	      "Genes Detected"=median(GenesDetected))
sumryAQC <- filter(pD, PassAll) %>%
    group_by(SampleID) %>%
    summarize("# After QC"=n())
sumry <- full_join(sumry,sumryAQC)
sumry <- sumry[,c(1,2,5,3,4)]
sumry <- group_by(pD, SampleID) %>%
    summarize("Number of cells"=n(),
	      "Total molecules"=median(UmiSums),
	      "Genes Detected"=median(GenesDetected))


mytheme <- gridExtra::ttheme_default(
    core = list(fg_params=list(cex = 0.8)),
    colhead = list(fg_params=list(cex = 0.8)),
    rowhead = list(fg_params=list(cex = 0.8)))

p1 <- tableGrob(sumry,rows=NULL,theme=mytheme)
p2 <- plot_grid(genesDetected, LibrarySize, cellViability,nrow=1,rel_widths=c(1,1,1.3))
p3 <- plot_grid(p2,p1,nrow=2)
print(p3)
```

## Actually applying the filter
```{r}
cells <- pD$barcode[pD$PassAll==TRUE]
m <- m[,cells]
pD <- pD[pD$barcode %in% cells,]
genes <- rowMeans(m)>0.01
m <- m[genes,]
```

# Batch effect is negligble
In order to assess the batch effect between the two 10x chips, we can look at the technical replicates that were spread across the two chips.
Each tSNE represents cells from one animal, and is colored by the two replicates, that were loaded on two separate chips.
```{r, fig.width=10, fig.height=13, warning=FALSE, message=FALSE}
conds <- unique(pD$Condition[pD$AnimalHadTumor==FALSE])
pltlist <- list()
for (cond in conds) {
    tsn <- read.csv(paste0("../data/Robjects/tSNE_",cond,"_raw.csv"))
    pD.sub <- right_join(pD,tsn)
    pD.sub <- arrange(pD.sub, prcntMito)
    pltlist[[cond]] <- ggplot(pD.sub, aes(x=tSNE1, y=tSNE2, color=SampleID)) +
	geom_point() +
	theme_classic() +
	ggtitle(cond)
}

plot_grid(plotlist=pltlist,ncol=2)
```

# tSNE by age of the animals
```{r, fig.width=12, fig.height=12, warning=FALSE, message=FALSE}
# conds <- unique(pD$Age[pD$AnimalHadTumor==FALSE])
conds <- list("38","41","46","53")
pltlist <- list()
for (cond in conds) {
    cond <- paste(cond,collapse="-")
    tsn <- read.csv(paste0("../data/Robjects/tSNE_",cond,"_raw.csv"))
    pD.sub <- right_join(pD,tsn)
    pD.sub <- arrange(pD.sub, prcntMito)
    pltlist[[cond]] <- ggplot(pD.sub, aes(x=tSNE1, y=tSNE2, color=Condition)) +
	geom_point() +
	theme_classic() +
	ggtitle(cond)
}

plot_grid(plotlist=pltlist,ncol=2)
```

## tSNE across ages 
```{r, fig.width=12, fig.height=12, warning=FALSE, message=FALSE}
# conds <- unique(pD$Age[pD$AnimalHadTumor==FALSE])
conds <- list(c("38","41"),
	      c("38","41","53"),
	      c("38","41","46"),
	      c("38","41","46","53"))
pltlist <- list()
for (cond in conds) {
    cond <- paste(cond,collapse="-")
    tsn <- read.csv(paste0("../data/Robjects/tSNE_",cond,"_raw.csv"))
    pD.sub <- right_join(pD,tsn)
    pD.sub <- arrange(pD.sub, prcntMito)
    pltlist[[cond]] <- ggplot(pD.sub, aes(x=tSNE1, y=tSNE2, color=Condition)) +
	geom_point() +
	theme_classic() +
	ggtitle(cond) 
	#         facet_wrap(~Age)
}

plot_grid(plotlist=pltlist,ncol=1)
```
