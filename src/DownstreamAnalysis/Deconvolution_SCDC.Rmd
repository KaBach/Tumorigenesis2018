---
title: "Deconvolution of RNA-Seq"
author: "Karsten Bach"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: journal
    highlight: tango
    code_folding: hide
---
***


# Quality Control
Here we analyse the data of bulk mammary glands (or tumors) from a total of 29 samples, 26 MGs and 3 tumors.

## Sample overview
There are are 7 different groups, untreated control (T0), only MPA treated (T1), and then 5 timepoints of DMBA treatment, 1 week, 3 weeks, 6 weeks, 9 weeks, 11 weeks. Each timepoint had four animals set up, two had to be culled because of tumor formation prior to collection and three animals had tumors on the day of collection. From these animals we have collected both tumor as well as the MGs.
```{r, warning=FALSE, message=FALSE}
library(ggplot2)
library(cowplot)
library(DT)
library(ggrepel)
theme_set(theme_cowplot())
# This is the sample annotation
bulk.data <- readRDS("../../data/Tumorigenesis/Robjects/DMBA_Bulk.rds")
expr <- bulk.data[["counts"]]
pDat <- bulk.data[["pDat"]]
```

### PCA Overview
- This is just a PCA overview (I already took out the tumor samples as I don't care too much about them)
```{r, message=FALSE,warning=FALSE}
library(edgeR)

# Set up DGEList
y <- DGEList(counts=expr,samples=pDat)
y <- y[,!y$samples$Tumor]
# Normalize
y <- calcNormFactors(y)
keep <- aveLogCPM(y) > aveLogCPM(10, lib.size=mean(y$samples$lib.size)) # removing rubbish
y <- y[keep,]

# Get Log-Cpm
logcpm <- cpm(y,log=TRUE)


# Compute PCA
pcs <- prcomp(t(logcpm))
logcpm.pc <- pcs$x
vars <- apply(logcpm.pc,2,var)
rel.vars <- round(vars/sum(vars)*100,1)

fPlot <- y$samples
fPlot$PC1 <- logcpm.pc[,1]
fPlot$PC2 <- logcpm.pc[,2]
fPlot$PC3 <- logcpm.pc[,3]
fPlot$PC4 <- logcpm.pc[,4]

# Plot
ggplot(fPlot, aes(x=PC1, y=PC2, color=Timepoint)) +
    geom_text(aes(label=Sample)) +
    theme_bw() +
    xlab(paste0("PC1(",rel.vars["PC1"],"%)")) +
    ylab(paste0("PC2(",rel.vars["PC2"],"%)")) +
    coord_fixed(1)
```

# Deconvolution
Trying SCDC.
## Data Preparation
### Bulk
```{r, message=FALSE,warning=FALSE}
library(Biobase)
library(SCDC)
pD <- AnnotatedDataFrame(pDat)
bulk.eset <- ExpressionSet(as.matrix(expr),phenoData=pD)
```

### SCE

```{r, message=FALSE,warning=FALSE}
sce <- readRDS("~../../data/Integrated/Robjects/SCE_combined_final.rds")

#Set sensible CellTypes
sce$CellTypes <- as.character(sce$CellTypesFinal)
sce$CellTypes[sce$CellTypes=="Hsp"] <- "Hs"
sce$CellTypes[grepl("^Ec|Pery|Swc",sce$CellTypes)] <- "Endothelial"
sce$CellTypes[grepl("cDC|DcCcr7|pDC",sce$CellTypes)] <- "DendriticCells"
sce$CellTypes[grepl("Trm",sce$CellTypes)] <- "Macrophages"
sce$CellTypes[sce$Groups=="Fibroblast"] <- "Fibroblast"
#sce$CellTypes[sce$Groups=="Myeloid"] <- "Myeloid"
#sce$CellTypes[sce$Groups=="Lymphoid"] <- "Lymphoid"
sce$CellTypes[sce$CellTypes %in% c("Bsl1","Bsl2","BslG")] <- "Basal"

# RM LpBsl
sce <- sce[,sce$CellTypes!="LpBsl"]
sce <- sce[,!grepl("Tam|Mst|Np|Mc|pD|Tm|Esn|Pc",sce$CellTypes)]


# Remove genes that I don't like
keepgenes <- SingleCellExperiment::rowData(readRDS("~../../data/Tumorigenesis/Robjects/SCE_QC_norm.rds"))
keepgenes <- rownames(keepgenes)[keepgenes$KeepForHvg]
sce <- sce[rownames(sce) %in% keepgenes,]

# Loop over Batches and don't select tumors
scelist <- list()
hvgs <- list()

for (btch in unique(sce$Batch)) {
# Downsample and only select the first batch
    sce.sub <- sce[,sce$Batch==btch & !grepl("TM",sce$SampleID)]
    set.seed(42)
    if (ncol(sce.sub)>=15000) {
    sce.sub <- sce.sub[,sample(1:ncol(sce.sub),15000)]
    }

    dec.var <- scran::modelGeneVar(sce.sub,block=sce.sub$SampleID)
    hvgs[[btch]] <- scran::getTopHVGs(dec.var,prop=.1)
    scelist[[btch]] <- sce.sub
}
# hvgs <- unique(unlist(hvgs))
# scelist <- lapply(scelist,function(SCE) SCE[hvgs,])
# Get cell types
cts <- lapply(scelist, function(SCE) unique(SCE$CellTypes))
cts <- Reduce("intersect",cts)

scelist <- lapply(scelist,function(SCE) SCE[,SCE$CellTypes %in% cts])
cells <- lapply(scelist, function(SCE) SCE$barcode)
cells <- Reduce("c",cells)

# Get Markers

sce.sub <- sce[,cells]

markers <- scran::findMarkers(sce.sub,factor(sce.sub$CellTypes),
			      pval.type="some",
			      block=sce.sub$SampleID,
			      lfc=log2(1.5))
genes <- lapply(markers,function(x) rownames(x)[x$FDR<0.01])
genes <- do.call(c,genes)
genes <- unique(genes)

scelist <- lapply(scelist,function(SCE) SCE[genes,])
```

## Run SCDC with major Groups

```{r, message=FALSE,warning=FALSE}
library(SCDC)
library(Biobase)

sc.eset.list <- list()
for (btch in seq_along(scelist)) {
    sc.eset.list[[btch]] <- ExpressionSet(as.matrix(counts(scelist[[btch]])),phenoData=AnnotatedDataFrame(data.frame(SingleCellExperiment::colData(scelist[[btch]]))))
}

rm(scelist)
rm(sce)
gc()

# Try on a pseudo bulk

bulk.pseudo <- generateBulk_allcells(sc.eset.list[[4]],
				     ct.varname="CellTypes",
				     sample="SampleID",
			   	     ct.sub=unique(sc.eset.list[[4]]$CellTypes))
# Estimate proportions

est.prop <- SCDC_prop(bulk.pseudo$pseudo_eset,
	  sc.eset.list[[1]],
	  ct.varname="CellTypes",
	  sample="SampleID",
	  ct.sub=unique(sc.eset.list[[1]]$CellTypes),
	  truep=bulk.pseudo$truep)

est.prop$peval


# I am skipping QC here because it takes for bloody ever

# Okay it doesn't seem horrible
# Try setting finer sub types for lymphoid cells
# Select marker gens specifically maybe?
# You possibly want to try the bulk conversion?

# Grid search needs a lot of mem



ens.prop <- SCDC_ENSEMBLE(bulk.eset,
			  sc.eset.list=sc.eset.list,
			  ct.varname="CellTypes",
			  sample="SampleID",
			  ct.sub=unique(sc.eset.list[[1]]$CellTypes))

#			  Transform_bisque=TRUE)
#                           grid.search=TRUE,
#                           search.length=0.01)

# 
# getPearson <- function(dt1, dt2, ct, subj){
#   cor(c(dt1[subj,ct]), c(dt2[subj,ct]))
# }
# ens_res <- function(wt, proplist, subject = colnames(expr)){
#   ens <- wt_prop(wt, proplist = proplist) 
#   p.ens <- getPearson(perou_pseudo_all$truep, ens ,
#                       ct = c("Hs","Avd","Basal","Lp"), subj = subject)
#   return(list(prop = ens, p = p.ens))
# }
# 
props <- wt_prop(ens.prop$w_table[3,1:5], ens.prop$prop.only[1:5])
props.lt <- reshape2::melt(props)
props.lt <- props.lt[,1:3]
colnames(props.lt) <- c("SampleID","CellTypes","Proportion")
props.lt$Condition <- substr(props.lt$SampleID,0,2)
props.lt$Condition[grepl("T$",props.lt$SampleID)] <- "Tumor"
props.lt <- props.lt[!grepl("Tumor",props.lt$Condition),]
props.lt$Proportion <- props.lt$Proportion*100
ggplot(props.lt, aes(x=Condition, y=Proportion)) +
    geom_boxplot() +
    facet_wrap(~CellTypes,scale="free")

# Try with hierarchical approach

sc.basis <- SCDC_basis(sc.eset,
	  ct.varname="CellTypes",
	  sample="SampleID",
	  ct.sub=unique(sc.eset$CellTypes))
df.d <- dist(t(log(sc.basis$basis.mvw + 1e-10)), method = "euclidean")
hc1 <- hclust(df.d, method = "complete")
plot(hc1, cex = 0.8, hang = -1, main = "log(basis matrix)")

sc.eset$Clusters <- "none"
sc.eset$Clusters[sc.eset$CellTypes %in% c("BCells")] <- "Bcs"
sc.eset$Clusters[sc.eset$CellTypes %in% c("BCells", "TCells", "Myeloid")] <- "Immune"
sc.eset$Clusters[sc.eset$CellTypes %in% c("Avd", "Hs", "Lp")] <- "Luminal"
sc.eset$Clusters[sc.eset$CellTypes %in% c("Endothelial", "Bsl1", "Fibroblast")] <- "BslFib"

est.prop <- SCDC_prop_subcl_marker(bulk.eset,
	  sc.eset,
	  ct.varname="CellTypes",
	  fl.varname="Clusters",
	  ct.fl.sub=unique(sc.eset$Clusters),
	  sample="SampleID",
	  ct.sub=unique(sc.eset$CellTypes),
	  LFC.lim=5)


est.prop <- SCDC_prop_subcl_marker(bulk.pseudo$pseudo_eset,
	  sc.eset,
	  ct.varname="CellTypes",
	  fl.varname="Clusters",
	  ct.fl.sub=unique(sc.eset$Clusters),
	  sample="SampleID",
	  ct.sub=unique(sc.eset$CellTypes),
	  LFC.lim=5,
	  truep=bulk.pseudo$truep)


props <- est.prop$prop.est
props.lt <- reshape2::melt(props)
props.lt <- props.lt[,1:3]
colnames(props.lt) <- c("SampleID","CellTypes","Proportion")
props.lt$Condition <- substr(props.lt$SampleID,0,2)
props.lt$Condition[grepl("T$",props.lt$SampleID)] <- "Tumor"

ggplot(props.lt, aes(x=Condition, y=Proportion)) +
    geom_boxplot() +
    facet_wrap(~CellTypes)

```

## Run MuSIC for cell types
I am hoping that this is better and ameliorates issues with the immune cells

## Approach2
Here we group cells first based on what music thinks
```{r, message=FALSE,warning=FALSE,fig.width=14,fig.height=14}
basis <- music_basis(sc.eset, 
   non.zero=TRUE,
   markers=NULL,
   clusters="CellTypes",
   samples="SampleID",
   verbose=TRUE)

# Plot the dendrogram of design matrix and cross-subject mean of realtive abundance
par(mfrow = c(1, 2))
d <- dist(t(log(basis$Disgn.mtx + 1e-6)), method = "euclidean")
# Hierarchical clustering using Complete Linkage
hc1 <- hclust(d, method = "complete" )
# Plot the obtained dendrogram
plot(hc1, cex = 0.6, hang = -1, main = 'Cluster log(Design Matrix)')
d <- dist(t(log(basis$M.theta + 1e-8)), method = "euclidean")
# Hierarchical clustering using Complete Linkage
# hc2 <- hclust(d, method = "complete" )
hc2 <- hclust(d, method = "complete")
# Plot the obtained dendrogram
plot(hc2, cex = 0.6, hang = -1, main = 'Cluster log(Mean of RA)')

cs <- cutree(hc1,k=3)
clusters <- paste0("C",cs)
names(clusters) <- names(cs)

cluster.type <- list()

#create bloody list
for (cl in unique(clusters)) {
    cluster.type[[cl]] <- names(clusters)[clusters==cl]
}

sce.hvg$CellGroups <- "none"
for (cl in names(cluster.type)) {
    cts <- cluster.type[[cl]]
    sce.hvg$CellGroups[sce.hvg$CellTypes %in% cts] <- cl
}


#Marker gene list within each group
grps <- unique(sce.hvg$CellGroups)
groupMarker <- list()
for (grp in grps) {
    sce.hvg.sub <- sce.hvg[,sce.hvg$CellGroups==grp]
    markers <- scran::findMarkers(sce.hvg.sub,factor(sce.hvg.sub$CellTypes),
				  pval.type="some",
				  block=sce.hvg.sub$SampleID)
    genes <- lapply(markers,function(x) rownames(x)[x$FDR<0.01])
    genes <- do.call(c,genes)
    genes <- unique(genes)
    groupMarker[[grp]] <- genes
}

# Marker gene list within each group
# This one based on hvgs
# grps <- unique(sce.hvg$CellGroups)
# groupMarker <- list()
# for (grp in grps) {
#     sce.hvg.sub <- sce.hvg[,sce.hvg$CellGroups==grp]
#     dec.var <- scran::modelGeneVar(sce.hvg.sub,block=sce.hvg.sub$SampleID)
#     hvgs <- scran::getTopHVGs(dec.var,prop=.8)
#     groupMarker[[grp]] <- hvgs
# }
# 
sc.eset <- ExpressionSet(as.matrix(counts(sce.hvg)),phenoData=AnnotatedDataFrame(data.frame(SingleCellExperiment::colData(sce.hvg))))

props <- music_prop.cluster(bulk.eset,
		   sc.eset,
		   group.markers=groupMarker,
		   groups="CellGroups",
		   clusters="CellTypes",
		   samples="SampleID",
		   clusters.type=cluster.type)


props.lt <- reshape2::melt(props)
props.lt <- props.lt[,1:3]
colnames(props.lt) <- c("SampleID","CellTypes","Proportion")
props.lt$Condition <- substr(props.lt$SampleID,0,2)
props.lt$Condition[grepl("T$",props.lt$SampleID)] <- "Tumor"

ggplot(props.lt, aes(x=Condition, y=Proportion)) +
    geom_boxplot() +
    facet_wrap(~CellTypes)
```
### Approach 1

Here identified the groups that MuSIC uses a priori based on prior knowledge of the cell types rather than inferring it from the data, that I will try in approach 2.
```{r, message=FALSE,warning=FALSE,fig.width=14,fig.height=14,eval=FALSE}

sce.hvg$CellGroups[sce.hvg$CellTypes %in% c("Bcs","Pc")] <- "Bcells"
sce.hvg$CellGroups[sce.hvg$CellTypes %in% c("Lp","Hs","Hsp","Avd","Bsl","Tm","LpBsl")] <- "Epithelial"
sce.hvg$CellGroups[sce.hvg$CellTypes %in% c("Trm1","Trm2","Tam")] <- "Macrophages"
sce.hvg$CellGroups[sce.hvg$CellTypes %in% c("cDC1","cDC2","DcCcr7","pDC")] <- "DendriticCells"
sce.hvg$CellGroups[sce.hvg$CellTypes %in% c("Ec1","Ec2","Ec3","Ec4","Peryc1","Peryc2","Swc","Mcs")] <- "OtherStroma"
sce.hvg$CellGroups[sce.hvg$CellTypes %in% c("TcCTL","TcCycl","TcNaiveCd4","TcNaiveCd8","TcNk",
					    "TmemCd4","TmemCd8","Tregs","Ilc")] <- "TCells"
sce.hvg$CellGroups[sce.hvg$CellTypes %in% c("Fb1","Fb2","Fb3","Fb4","Fb5Att","Fb6","Fb7","Fb8","Fb9")] <- "Fibroblasts"

#
sc.eset <- ExpressionSet(as.matrix(counts(sce.hvg)),phenoData=AnnotatedDataFrame(data.frame(SingleCellExperiment::colData(sce.hvg))))

# Make the goddamn fucking list because they are too lazy to do it themselves
cluster.type <- list()
for (clt in unique(sce.hvg$CellGroups)) {
    tbbl <- table(sce.hvg$CellTypes,sce.hvg$CellGroups)
    cluster.type[[clt]] <- rownames(tbbl)[tbbl[,clt]!=0]
}


# Marker gene list within each group
grps <- unique(sce.hvg$CellGroups)
groupMarker <- list()
for (grp in grps) {
    sce.hvg.sub <- sce.hvg[,sce.hvg$CellGroups==grp]
    dec.var <- scran::modelGeneVar(sce.hvg.sub,block=sce.hvg.sub$SampleID)
    hvgs <- scran::getTopHVGs(dec.var,prop=.5)
    groupMarker[[grp]] <- hvgs
}

props <- music_prop.cluster(bulk.eset,
		   sc.eset,
		   group.markers=groupMarker,
		   groups="CellGroups",
		   clusters="CellTypes",
		   samples="SampleID",
		   clusters.type=cluster.type)


props.lt <- reshape2::melt(props)
props.lt <- props.lt[,1:3]
colnames(props.lt) <- c("SampleID","CellTypes","Proportion")
props.lt$Condition <- substr(props.lt$SampleID,0,2)
props.lt$Condition[grepl("T$",props.lt$SampleID)] <- "Tumor"

ggplot(props.lt, aes(x=Condition, y=Proportion)) +
    geom_boxplot() +
    facet_wrap(~CellTypes)

```

