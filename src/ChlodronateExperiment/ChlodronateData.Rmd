---
title: "Chlodronate Data"
date: '`r Sys.Date()`'
output:
  html_notebook:
    theme: united
    highlight: tango
    code_folding: hide
---
***

# Introduction

Here I have a quick look at the Chlodronate data if there is anything exciting.
The cell types are based on predicition from the other dataset, so less clean than annotating manual but should give reasonably good results.

```{r, message=FALSE,warning=FALSE}

library(randomForest)
library(scran)
library(scater)
library(ggplot2)
library(cowplot)
theme_set(theme_cowplot())
sce <- readRDS("../../data/Tumorigenesis/Robjects/Chlodronate_SCE_QC_norm.rds")
tree <- readRDS("../../data/Integrated/Robjects/Tree.rds")
ump <- read.csv("../../data/Tumorigenesis/Robjects/Chlodronate_UMAP_corrected.csv",stringsAsFactors=FALSE)[,-1]
sce <- scater::logNormCounts(sce)
pD <- data.frame(colData(sce))
pD <- dplyr::left_join(pD,ump)
pD$ChlodronateExperiment <- pD$Condition %in% c("WKBR96.1d","WKBR96.1e",
						"WKBR89.4h","WKBR89.4j",
						"WKBR89.4i")
```

# Data

We had animals from `r length(unique(pD$Condition))` animals, with 4 treated and 3 controls.

```{r, message=FALSE,warning=FALSE}
pred <- predict(tree,t(logcounts(sce)))
pD$CellTypes <- pred
pD$CellTypes <- factor(pD$CellTypes)
```

## UMAP
This is the whole dataset with annotation.
```{r, message=FALSE,warning=FALSE}
X <- model.matrix(~0+pD$CellTypes)
colnames(X) <- levels(pD$CellTypes)
X <- t(t(X)/colSums(X))
celltyp_ctrs <- data.frame(crossprod(X, as.matrix(pD[,c("UMAP1","UMAP2")])))
celltyp_ctrs$CellType <- rownames(celltyp_ctrs)

p0 <- ggplot(pD, aes(x=UMAP1, y=UMAP2)) +
    geom_point() +
    ggtitle("Cluster") +
    geom_label(data=celltyp_ctrs, aes(x=UMAP1, y=UMAP2, label=CellType, color=NULL)) +
    theme(legend.position="none") 
p0
```

This is now the treated in black overlaid on the untreated in grey, which is hard to see as the overlap perfectly.

```{r, message=FALSE,warning=FALSE,fig.width=10,fig.height=10}
pD.t <- pD[pD$ChlodronateExperiment,]
pD.c <- pD[!pD$ChlodronateExperiment,]
library(ggplot2)
p1 <- ggplot(pD.c, aes(x=UMAP1, y=UMAP2)) +
    geom_point(color="grey50") +
    ggtitle("Cluster") +
    geom_point(data=pD.t, color="black",size=.8) +
    theme(legend.position="none") 
p1
```

## Differential Abundance
We can more formerly test for difference in abundance between cell types.
```{r, message=FALSE,warning=FALSE}
cluster.counts <- table(pD$CellTypes, pD$Condition)
cluster.counts <- cluster.counts[rowMeans(cluster.counts)>10,]

library(dplyr)
sumry <- group_by(pD, Batch, Condition, ChlodronateExperiment) %>%
    summarize()

sumry$ChlodronateExperiment <- as.character(sumry$ChlodronateExperiment)

# EdgeR
library(edgeR)
# Set up DGE
y.ab <- DGEList(cluster.counts)
y.ab$samples$Condition <- colnames(y.ab)
y.ab$samples <- left_join(y.ab$samples,sumry)
colnames(y.ab) <- y.ab$samples$Condition

# y.ab <- calcNormFactors(y.ab)

des <- model.matrix(~ ChlodronateExperiment,y.ab$samples)

y.ab <- estimateDisp(y.ab, des, trend="none")
#plotBCV(y.ab,cex=1)

fit.ab <- glmQLFit(y.ab, des, robust=TRUE, abundance.trend=FALSE)
#summary(fit.ab$var.prior)
#summary(fit.ab$df.prior)
#plotQLDisp(fit.ab, cex=1)

res <- glmQLFTest(fit.ab, coef=ncol(fit.ab$design))
summary(decideTests(res,p.value=0.1))
tab <- topTags(res,n=40)$table
tab$CellTypes <- rownames(tab)
tab$CellTypes <- factor(tab$CellTypes, levels=tab$CellTypes)
library(ggrepel)
ggplot(tab, aes(x=logFC, y=-log10(FDR),color=CellTypes)) +
    geom_point(size=4) +
    geom_hline(yintercept=1) +
    geom_label_repel(data=tab[tab$FDR<0.5,], label=rownames(tab[tab$FDR<0.5,]),aes(color=NULL)) +
    #     scale_color_manual(values=levels(tab$Colors)) +
    theme(legend.position="none")
```

## Differential Expression
Just in case I compare the alveolar compartement in treated vs untreated
(there are no DE genes for LPs)
```{r, message=FALSE,warning=FALSE}
# erneg <- c("Avp1","Avp2","Avd","Lp")
# pD$CellTypes <- as.character(pD$CellTypes)
# pD$CellTypes[pD$CellTypes %in% erneg] <- "ErNeg"

colData(sce) <- DataFrame(pD)
sce.sub <- sce[,sce$CellTypes=="Avd"]
sumd <- aggregateAcrossCells(sce.sub, 
			     DataFrame("Condition"=sce.sub$Condition))

m <- assay(sumd,"counts")
#
# remove low lib sizes
library(edgeR)
y.exp <- DGEList(m,samples=data.frame(colData(sumd)))
discarded <- isOutlier(y.exp$samples$lib.size, log=TRUE, type="lower")
y.exp <- y.exp[,!discarded]

y.exp$samples$Treated <- y.exp$samples$Condition %in% c("WKBR96.1d","WKBR96.1e",
						"WKBR89.4h","WKBR89.4j",
						"WKBR89.4i")
y.exp$samples$Treated <- factor(ifelse(y.exp$samples$Treated,
				"Treat",
				"Untreat"))
# remove lowly expressed genes
keep <- filterByExpr(y.exp, group=y.exp$samples$Treated)
y.exp <- y.exp[keep,]


# normalization
y.exp <- calcNormFactors(y.exp)

dsgn <- model.matrix(~ y.exp$samples$Treated)

# Dispersion estimation
y.exp <- estimateDisp(y.exp, dsgn)
#summary(y.exp$trended.dispersion)
#plotBCV(y.exp)

# QL dispersion
fit.exp <- glmQLFit(y.exp, dsgn, robust=TRUE)
#summary(fit.exp$var.prior)
#summary(fit.exp$df.prior)
#plotQLDisp(fit.exp)  

res.exp <- glmQLFTest(fit.exp)#, contrast=con)
top <- topTags(res.exp, n=16876)$table
top$Gene <- rownames(top)
sig <- top[top$FDR<0.1,]

p2 <- ggplot(top, aes(x=logFC, y=-log10(FDR))) +
    geom_point() +
    ggtitle("Untreated-Treated")
if (nrow(sig)>1) {
    p2 <- p2 +
	geom_label(data=sig, aes(label=Gene))
}
p2
```

