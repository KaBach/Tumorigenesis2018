---
title: "Epithelial cells in BRCA1 data"
author: "Karsten Bach"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: united
    highlight: tango
    code_folding: hide
---
***

```{r, message=FALSE,warning=FALSE}
library(scran)
library(DT)
library(scater)
library(plyr)
library(dplyr)
library(knitr)
library(ggplot2)
library(Rtsne)
library(cowplot)
library(Matrix)
library(irlba)
library(reshape2)
library(gridExtra)
library(gridGraphics)
source("functions.R")

dataList <- readRDS("../data/firstBatch_Robjects/ExpressionList_QC.rds")
sfs <- read.csv("../data/firstBatch_Robjects/SizeFactors.csv")
m <- dataList[["counts"]]
pD <- dataList[["phenoData"]]
pD <- left_join(pD,sfs)
fD.full <- dataList[["featureData"]]
rm(dataList)

anno <- read.csv("../data/firstBatch_Robjects/CellTypes.csv")[,-1]
umap <- read.csv("../data/firstBatch_Robjects/UMAP_all.csv")[,-1]
substructure <- read.csv("../data/firstBatch_Robjects/Substructure.csv")[,-1]
ttime <- read.csv("../data/firstBatch_Robjects/TumorTime.csv")[,-1]
pD <- right_join(pD,anno)
pD <- left_join(pD,umap)
pD <- left_join(pD,substructure)
pD <- left_join(pD,ttime)

cellSums <- as.vector(table(pD$ranktumorTime))

pD <- pD[pD$Groups=="Epithelial",]
m <- m[,pD$barcode]
pD$CellType <- droplevels(pD$CellType)
pD$Colors <- droplevels(pD$Colors)
# keepgenes <- fD$uniqnames[fD$KeepForHvg]
m <- log2(t(t(m)/pD$sf)+1)
m.full <- m <- as(m,"dgCMatrix") #cases where I need all genes for viz
fD <- fD.full[rowMeans(m)>0.01,]# & fD$uniqnames %in% keepgenes,]
m <- m[rowMeans(m)>0.01,]# & rownames(m) %in% keepgenes,]
rownames(pD) <- pD$barcode
```

# Overview
The UMAP below is computed on HVGs for all epithelial cells in the dataset.
Epithelial cells are defined by the expression of Epcam.
```{r, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
library(viridis)
p0 <- ggplot(pD, aes(x=Group.UMAP1, y=Group.UMAP2, color=CellType)) +
    geom_point() +
    ggtitle("Cluster") +
    scale_color_brewer(palette="Set2") 
    #     theme(legend.position="bottom",
    #           legend.direction="horizontal")
p1 <- ggplot(pD, aes(x=Group.UMAP1, y=Group.UMAP2, color=ranktumorTime)) +
    geom_point() +
    scale_color_viridis(option="B") #+
    #     theme(legend.position="bottom",
    #           legend.direction="horizontal")
p0
ggsave("UmapEpithelial.svg")
p1
# overviewplot(m,pD,"Epcam")

```

## Relationship of Clusters
Similarity shown as graph abstraction. The thicker the connecting line, the higher the similarity. The bigger the blob, the higher the cell number.
```{r, fig.width=7, width=7, warning=FALSE, message=FALSE}
# Highly Variable Genes
hvg <- getHighVar(m,get.var.out=TRUE,supress.plot=TRUE)
hvg <- hvg[(rownames(hvg) %in% fD$uniqnames[fD$KeepForHvg]),]	
hvg <- rownames(hvg[order(hvg$bio, decreasing=TRUE),])[1:(nrow(hvg)/10)]
set.seed(300)
igr <- buildSNNGraph(m[hvg,],pc.approx=TRUE,k=10)

# Test Graph abstraction
library(igraph)
x <- clusterModularity(igr,pD$CellType,get.values=TRUE)
obexp <- x$observed/x$expected
grph <- graph_from_adjacency_matrix(obexp,weighted=TRUE,diag=FALSE,mode="undirected")
plot(grph,edge.width=E(grph)$weight*10, vertex.size=as.vector(table(pD$CellType))/100)
```

### Change in time of the graph extraction
The graph abstraction above is computed on all timepoints. It might be more relevant to look at this at the various timepoints.
Similarity shown as graph abstraction changing over time.
- We can observe a change in proportion of cluster here visualized by vertex sizes
- Not sure if the high modularity between Lp and Tm1/2 in t=6|7 is influenced by the small cell number?
- 
```{r, fig.width=9, fig.height=10, warning=FALSE, message=FALSE}
library(GGally)
library(intergraph)
library(network)
plist <- list()
pal <- levels(pD$Colors)
names(pal) <- levels(pD$CellType)
for (i in c(1:8)) {
    pD.sub <- pD[pD$ranktumorTime==i,]
    m.sub <- m[,pD.sub$barcode]
    pD.sub$CellType <- droplevels(pD.sub$CellType)
    pD.sub$Colors <- droplevels(pD.sub$Colors)
    # Highly Variable Genes
    hvg <- getHighVar(m.sub,get.var.out=TRUE,supress.plot=TRUE)
    hvg <- hvg[(rownames(hvg) %in% fD$uniqnames[fD$KeepForHvg]),]	
    hvg <- rownames(hvg[order(hvg$bio, decreasing=TRUE),])[1:(nrow(hvg)/10)]
    set.seed(300)
    igr <- buildSNNGraph(m.sub[hvg,],pc.approx=TRUE,k=10)

    # Test Graph abstraction
    library(igraph)
    x <- clusterModularity(igr,pD.sub$CellType,get.values=TRUE)
    obexp <- x$observed/x$expected
    grph <- graph_from_adjacency_matrix(obexp,weighted=TRUE,diag=FALSE,mode="undirected")
    nrmweights <- E(grph)$weight/max(E(grph)$weight) * 3  
    net <- asNetwork(grph)
    vertx.size <- as.vector(table(pD.sub$CellType))/(nrow(pD.sub))
    vertx.size <- vertx.size*(10/max(vertx.size)) # scale to a max of 10
    net %v% "ct" <- network.vertex.names(net)
    plist[[i]] <- ggnet2(net, edge.size=nrmweights,
			 size=vertx.size,
			 layout.exp=1,
			 mode=layout_nicely(grph),
			 label=TRUE,
			 legend.position="none",
			 color="ct",
			 palette=pal,
			 max_size=10) +
		  ggtitle(paste0("t=", i))
    }
plot_grid(plotlist=plist)
```


## Markers for the various epithelial populations
```{r, fig.width=4, fig.height=8, warning=FALSE, message=FALSE}
markers <- findMarkers(m,pD$CellType,pval.type="all")
genes <- lapply(markers,function(x) rownames(x)[1:5])
genes <- do.call(c,genes)
genes <- unique(genes)
p <- bubblePlot(m, genes, pD$CellType ,angled=TRUE) + coord_flip() + scale_color_viridis(option="C")
ggsave("ExpressionEpithelial.pdf",width=8,height=3.5)
```

## Changes of epithelial composition over time
The plots below summarize the changes in cluster frequencies over the "tumor time". Relative to either all cells or only within epithelium.
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
tbl <- table(pD$CellType,pD$tumorTime)
tbl <- t(t(tbl)/cellSums)
tst <- melt(tbl)
ggplot(tst, aes(x=Var2,y=value, group=Var1)) +
    geom_point() +
    geom_smooth() +
    facet_wrap(~Var1) +
    ylim(c(0,1)) +
    ggtitle("Relative to All Cells")

sumry <- group_by(pD, tumorTime, CellType) %>%
    summarize(n=n()) %>%
    mutate(frac=n/sum(n)) %>%
    ungroup()
ggplot(sumry, aes(x=tumorTime, y=frac, group=CellType)) +
    geom_point() +
    geom_smooth() +
    facet_wrap(~CellType) +
    ylim(c(0,1)) +
    ggtitle("Relative to Epithelial")
sumry$ranktumorTime <- rank(sumry$tumorTime,ties.method="min")
ggplot(sumry, aes(x=as.numeric(factor(tumorTime)), y=frac,fill=CellType)) +
    geom_bar(stat="identity") +
    ylim(c(0,1)) +
    ggtitle("Relative to Epithelial") +
    scale_fill_brewer(palette="Dark2") +
    xlab("Time") +
    ylab("Proportion")


# Ribbon plot
sumry <- group_by(pD, tumorTime, CellType) %>%
    summarize(n=n()) %>%
    mutate(frac=n/sum(n)) %>%
    ungroup() # %>%
#     mutate(cumfrac=cumsum(frac)) %>%
#     ungroup()

comb <- table(sumry$CellType,sumry$tumorTime) 
missing.comb <- which(comb==0, arr.ind=TRUE)
add.missing <- data.frame("CellType"=rownames(missing.comb),
		  "tumorTime"=colnames(comb)[missing.comb[,"col"]],
		  "frac"=0,
		  "n"=0)
sumry <- rbind(sumry,add.missing)
sumry <- arrange(sumry, tumorTime, CellType) %>%
    group_by(tumorTime) %>%
    mutate(cumfrac=cumsum(frac)) %>%
    ungroup()

ggplot(sumry, aes(x=as.numeric(tumorTime), ymin=cumfrac-frac, ymax=cumfrac,
		  fill=CellType)) +
    geom_ribbon() +
    scale_fill_brewer(palette="Set2") +
    xlab("Tumor Development") +
    ylab("Fraction of Cells")
ggsave("RibbonEpithelial.svg")
```

# Integration w previous data
- As done for the 11a data, I thought it might be helpful to view the data in terms of normal development and integrated it with the NP and G timepoint from our paper as well as the lineage tracing data
- I find it curious that the Av cluster in the bottom right plot gets split in two. Is there a part that resembles normal alveogenesis, and cells that are not comparable to normal alveologenesis?
- Below is the integration and a UMAP visualization of all virigin wildtype samples to check overlap
```{r, fig.width=10, fig.height=5, warning=FALSE, message=FALSE, cache=TRUE}
# Load
mDat <- readRDS("../data/firstBatch_Robjects/ExpressionList_Mapped_fastMNN.rds")
m.cor <- mDat[["counts"]]
pD.cor <- mDat[["phenoData"]]
m.uncor <- mDat[["uncor"]]
rm(mDat)

# shuffle batches for plotting
set.seed(300)
pD.cor <- pD.cor[sample(1:nrow(pD.cor)),]
m.cor <- m.cor[pD.cor$barcode,]
m.uncor <- m.uncor[,pD.cor$barcode]

# Add cluster annotation
pD.cor <- left_join(pD.cor,pD[,c("barcode","CellType","ranktumorTime","tumorTime")])
# for mamgland data
mDatanno <- read.csv("../data/firstBatch_Robjects/MammGland_Cluster.csv")
colnames(mDatanno) <- c("barcode","OldCluster")
pD.cor <- left_join(pD.cor, mDatanno)
# for lintracing data
# !
# !
# !
# !

library(umap)
ump <- umap(m.cor, min_dist=0.5, metric="pearson", random_state=42)
pD.cor$UMAP1 <- ump$layout[,1]
pD.cor$UMAP2 <- ump$layout[,2]
p_cor <- ggplot(pD.cor[pD.cor$Condition %in% c("NP","CBLT","ctrl"),], aes(x=UMAP1, y=UMAP2, color=Condition)) +
    geom_point() +
    ggtitle("MNN-Corrected only NP") 

pcs <- prcomp_irlba(t(m.uncor),n=50)
ump.uncor <- umap(pcs$x, min_dist=0.5, metric="pearson", random_state=42)
pD.cor$UMAP1.uncor <- ump.uncor$layout[,1]
pD.cor$UMAP2.uncor <- ump.uncor$layout[,2]

p_uncor <- ggplot(pD.cor[pD.cor$Condition %in% c("NP","CBLT","ctrl"),], aes(x=UMAP1.uncor, y=UMAP2.uncor, color=Condition)) +
    geom_point() +
    ggtitle("Uncorrected only NP") +
    theme(legend.position="none")
plot_grid(p_uncor, p_cor)
```

```{r, fig.width=10, fig.height=5, warning=FALSE, message=FALSE}
p0 <- ggplot(pD.cor, aes(x=UMAP1, y=UMAP2, color=CellType)) +
    geom_point() +
    facet_wrap(~Condition)

p1 <- ggplot(pD.cor[!pD.cor$Condition %in% c("NP","G"),], aes(x=UMAP1, y=UMAP2, color=tumorTime)) +
    geom_point() +
    scale_color_viridis(option="B") 
plot_grid(p0,p1)
```

## RF on development data
- Are there cells in the Av cluster that don't look like alveolar cells anymore?
```{r, fig.width=10, fig.height=5, warning=FALSE, message=FALSE}
mamDat <- readRDS("../data/firstBatch_Robjects/MamGlandData_QCnormclustered.rds")
m2 <- mamDat[["counts"]]
pD2 <- mamDat[["phenoData"]]
rm(mamDat)
pD2$keep <- pD2$keep & pD2$Condition %in% c("NP","G") & !(pD2$SuperCluster %in% c("Myo","Prc"))

m2 <- m2[,pD2$keep]
pD2 <- pD2[pD2$keep,]
m2 <- m2[rowMeans(m2) > 0.01,]
m2 <- t(log2(t(m2)/pD2$sf+1))
rownames(m2) <- mapvalues(rownames(m2),fD.full$id,fD.full$uniqnames)

m2 <- m2[intersect(rownames(m.full),rownames(m2)),]
genes <- findMarkers(m2,pD2$SuperCluster)
genes <- unlist(lapply(genes,function(x) rownames(x)[1:100]))
genes <- unique(genes)
genes <- intersect(genes,rownames(m)) # This is removing variables from the prediciton! Impact seems to be negligble.. Could be done better if necessary..

labls <- factor(pD2$SuperCluster)
set.seed(300)
sam <- sample(1:ncol(m2),floor(0.8*ncol(m2)))
train.labls <- labls[sam]
train.data <- as.matrix(m2[genes,sam])
test.labls <- labls[-sam]
test.data <- as.matrix(m2[genes,-sam])

library(randomForest)
Tree <- randomForest(x=t(train.data),y=train.labls,
		     xtest=t(test.data),ytest=test.labls,keep.forest=TRUE)
Tree$confusion
varImpPlot(Tree,
	   sort=T,
	   n.var=20,
	   main="Top 20 - Variable Importance")

# Predict
pred <- predict(object=Tree, newdata=t(m),type="prob")
pred <- data.frame(pred)
pred$Cluster <- pD$CellType
fP <- melt(pred)

ggplot(fP, aes(x=Cluster,y=value, fill=variable)) +
    geom_boxplot(outlier.size=0) +
    theme(legend.position="bottom",legend.direction="horizontal") +
    ggtitle("Probability of being classified as epithelial cell from dev data")
```

## Being primed for becoming a tumor
The basic question is, can we identify cells in the Lp or Av compartment that are likely on their way to giving rise to tumors.
- Approaches:
1. Find PCs or DCs in the compartment that correlate with tumorigenesis other than alveologenesis 
2. Compute similarity between each Lp/Av cell and Tm1/Tm2, hopefully there are outliers?
```{r, fig.width=9, fig.height=9, warning=FALSE, message=FALSE}
pD.sub <- pD[pD$CellType %in% c("Lp","Av","Tm1","Tm2"),]
m.sub <- m[,pD.sub$barcode]

# Highly Variable Genes
# hvg <- getHighVar(m.sub,get.var.out=TRUE,supress.plot=TRUE)
# hvg <- hvg[(rownames(hvg) %in% fD$uniqnames[fD$KeepForHvg]),]	
# hvg <- rownames(hvg[order(hvg$bio, decreasing=TRUE),])[1:(nrow(hvg)/20)]
# hvg <- rownames(hvg[hvg$FDR <= 0.05 & hvg$bio >=0.2,])

fDM <- t(as.matrix(m.sub[hvg,]))
library(irlba)
fpca <- t(m.sub[rowMeans(m.sub)>0.01,])
fDM.pc <- prcomp_irlba(fpca,n=50)
fDM <- fDM.pc$x

pD.sub$PC1 <- fDM[,1]
pD.sub$PC2 <- fDM[,2]
pD.sub$PC3 <- fDM[,3]
pD.sub$PC4 <- fDM[,4]
pD.sub$PC5 <- fDM[,5]
pD.sub$PC6 <- fDM[,6]

colnames(fpca)[order(fDM.pc$rotation[,3],decreasing=FALSE)][1:50]
plot(fDM.pc$rotation[,3] ~ fDM.pc$rotation[,1],pch=19)
library(destiny)
set.seed(300)
dm <- DiffusionMap(fDM)
pD.sub$DC1 <- eigenvectors(dm)[,1]
pD.sub$DC2 <- eigenvectors(dm)[,2]
pD.sub$DC3 <- eigenvectors(dm)[,3]
pD.sub$DC4 <- eigenvectors(dm)[,4]
pD.sub$DC5 <- eigenvectors(dm)[,5]
pD.sub$DC6 <- eigenvectors(dm)[,6]
pD.sub$Csn2 <- fpca[,"Mif"]

ggplot(pD.sub[pD.sub$ranktumorTime!=8,], aes(x=DC1, y=DC4, color=CellType)) +
    geom_point()

ggplot(pD.sub[pD.sub$ranktumorTime!=8,], aes(x=PC1, y=PC3, color=CellType)) +
    geom_point()

ggplot(pD.sub[pD.sub$ranktumorTime!=8,], aes(x=PC1, y=PC3)) +
    geom_hex() +
    scale_fill_viridis(option="B") +
    facet_wrap(~ranktumorTime)

ggplot(pD.sub[pD.sub$ranktumorTime!=8,], aes(x=PC1, y=PC3,color=Csn2)) +
    geom_point() +
    scale_color_viridis(option="B") +
    facet_wrap(~ranktumorTime)

plist <- list()
for (i in c(1:6)) {
    dc <- paste0("PC",i)
    plist[[i]] <- ggplot(pD.sub, aes_string(x="factor(ranktumorTime)",y=dc))+
	geom_boxplot() +
	ggtitle(dc)
}
plot_grid(plotlist=plist)
```

```{r, fig.width=9, fig.height=9, warning=FALSE, message=FALSE}
pD.sub <- pD[pD$CellType %in% c("Lp","Av"),]
m.sub <- m[,pD.sub$barcode]

# Highly Variable Genes
hvg <- getHighVar(m.sub,get.var.out=TRUE,supress.plot=TRUE)
hvg <- hvg[(rownames(hvg) %in% fD$uniqnames[fD$KeepForHvg]),]	
# hvg <- rownames(hvg[order(hvg$bio, decreasing=TRUE),])[1:(nrow(hvg)/20)]
hvg <- rownames(hvg[hvg$FDR <= 0.05 & hvg$bio >=0.2,])

library(destiny)
set.seed(300)
dm <- DiffusionMap(t(as.matrix(m.sub[hvg,])))
pD.sub$DC1 <- eigenvectors(dm)[,1]
pD.sub$DC2 <- eigenvectors(dm)[,2]
pD.sub$DC3 <- eigenvectors(dm)[,3]
pD.sub$DC4 <- eigenvectors(dm)[,4]
pD.sub$DC5 <- eigenvectors(dm)[,5]
pD.sub$DC6 <- eigenvectors(dm)[,6]

ggplot(pD.sub, aes(x=DC1, y=DC2, color=CellType)) +
    geom_point()

ggplot(pD.sub, aes(x=DC1, y=DC6, color=tumorTime)) +
    geom_point() +
    scale_color_viridis(option="B")

plist <- list()
for (i in c(1:6)) {
    dc <- paste0("DC",i)
    plist[[i]] <- ggplot(pD.sub, aes_string(x="factor(ranktumorTime)",y=dc))+
	geom_boxplot() +
	ggtitle(dc)
}
plot_grid(plotlist=plist)
```
