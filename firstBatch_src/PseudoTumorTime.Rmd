---
title: "Changes through tumor progression"
author: "Karsten Bach"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: united
    highlight: tango
    code_folding: hide
---
***

```{r, message=FALSE,warning=FALSE}
library(scran)
library(scater)
library(plyr)
library(dplyr)
library(knitr)
library(ggplot2)
library(Rtsne)
library(cowplot)
library(Matrix)
library(gridExtra)
library(pheatmap)
library(irlba)
library(limma)
library(viridis)
library(reshape2)
source("functions.R")

dataList <- readRDS("../data/firstBatch_Robjects/ExpressionList_QC.rds")
sfs <- read.csv("../data/firstBatch_Robjects/SizeFactors.csv")
m <- dataList[["counts"]]
pD <- dataList[["phenoData"]]
pD <- left_join(pD,sfs)
fD <- dataList[["featureData"]]
rm(dataList)

tsn <- read.csv("../data/firstBatch_Robjects/tSNE_38-41-46-53_raw.csv")
umap <- read.csv("../data/firstBatch_Robjects/UMAP_all.csv",row.names=1)
anno <- read.csv("../data/firstBatch_Robjects/Cluster_final.csv")[,-1]
pD <- right_join(pD,tsn)
pD <- left_join(pD,anno)
pD <- left_join(pD,umap)
rownames(pD) <- pD$barcode

m <- m[,pD$barcode]
keep <- rowSums(m)>8 # This rnd appearing threshold is set only to gain memory, the actual computation of DE genes etc. is done later per cluster where genes with mean lower than 0.01 are removed as usual. The 8 stems from the fact that the smalles cluster has 88 cells and then 8 would be 0.1 average if all counts would be in this cluster.
m <- m[keep,] 
m <- log2(t(t(m)/pD$sf)+1)
m <- as(m,"dgCMatrix")
fD <- fD[keep,]

uniqnames <- uniquifyFeatureNames(fD$id,fD$symbol)
uniqnames <- gsub("-",".",uniqnames)
fD$uniqnames <- uniqnames
rownames(m) <- uniqnames
overviewPlot <- function(m,pD,gene,
			 dim1="UMAP1",dim2="UMAP2",
			 variable="ClusterLabels") {
    require(cowplot)
    require(viridis)
    exps <- data.frame(gene=m[gene,],
			barcode=colnames(m))
    colnames(exps)[1] <- gene
    pD <- left_join(pD,exps)
    p0 <- ggplot(pD, aes_string(x=variable, y=gene, fill=variable)) +
	geom_boxplot() +
	theme(legend.position="none",
	      axis.text=element_text(size=7))

    p1 <- ggplot(pD, aes_string(x=dim1, y=dim2, color=gene)) +
	geom_point() +
	theme_void() +
	ggtitle(gene) +
	scale_color_viridis()

    pout <- plot_grid(p1,p0,nrow=1)
    return(pout)
}

subPlot <- function(m, pD, clust, colBy="SubClusterLabels") {
    pD.sub <- pD[pD$ClusterLabels==clust,]
    m.sub <- m[,pD.sub$barcode]
    p <- ggplot(pD.sub, aes_string(x="Sub.tSNE1", y="Sub.tSNE2", color=colBy)) +
	geom_point()
    return(p)
}
```

# Concept
The idea is to find a signal in the data that captures the progression of the samples from normal to tumor.
Technically, age might be a good indicator, however the age at which the animals develop tumors is quite variable.
Hence, we here try to infer the stage along the process of tumorigenesis from the data.

## Myeloid cells in the dataset 
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C2","C3","C16","C20")
kable(data.frame("Cluster"=clust,
		 "CellType"=c("Neutrophils","Macrophages","Dendritic Cells","Macrophages")),
	         "Marker"=c("S100a8","F4/80","C209a","Dnase1l3"))

pD.sub <- pD[pD$ClusterLabels %in% clust,]
m.sub <- m[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]
```

# Constructing a "tumor time"
In an attempt to capture all chagnes in the myeloid compartment, I average expression per animal over all myeloid clusters and compute the PCA based on this. The first principal component appears to capture the "tumor signal".
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE, cache=TRUE}
## PCA per sample on immune cells
out <- data.frame(numeric(nrow(m.sub)))
colnames(out) <- levels(factor(pD.sub$Condition))[1]
for (cond in levels(factor(pD.sub$Condition))) {
    expr <- rowMeans(m.sub[,pD.sub$Condition==cond])
    colname <- cond
    out[,colname] <- expr
}
rownames(out) <- rownames(m.sub)
pcs <- prcomp(t(out))
pca <- data.frame(pcs$x)
pca[,"Condition"] <- colnames(out)
ages <- pD[!duplicated(pD$Condition),c("Condition","Age")]
pca <- left_join(pca, ages)
rownames(pca) <- pca$Condition

library(ggrepel)
ggplot(pca, aes(x=PC1, y=PC2, color=Age,label=Condition)) +
    geom_text_repel(size=3) +
    geom_point()
# 
rots <- pcs$rotation
rots <- rots[order(abs(rots[,"PC1"]),decreasing=TRUE),]

# Add PC1 coordinates to pD
tumorTime <- pca$PC1
tumorTime <- tumorTime-min(tumorTime)
tumorTime <- tumorTime/max(tumorTime)
names(tumorTime) <- rownames(pca)
pD$tumorTime <- mapvalues(pD$Condition,names(tumorTime),tumorTime)
pD$tumorTime <- as.numeric(as.character(pD$tumorTime))
pD$ranktumorTime <- factor(mapvalues(pD$Condition,names(tumorTime),rank(tumorTime)),levels=
			   c(1:8))
pD$ranktumorTime <- factor(pD$ranktumorTime)


# ggplot(test, aes(x=ranktumorTime))+#, fill=SubClusterLabels)) +
#     geom_bar() +
#     facet_wrap(~SubClusterLabels,scales="free_y")

library(gganimate)
pD$ranktumorTime <- factor(pD$ranktumorTime)
tranTimes <- sort(as.numeric(as.character((unique(pD$tumorTime)))))
tranTimes <- diff(tranTimes)
p <- ggplot(pD, aes(x=UMAP1, y=UMAP2, color=ClusterLabels)) +
    geom_point() +
    #     geom_density_2d(color="black") +
    transition_states(ranktumorTime,
		      transition_length=tranTimes,
		      state_length=1,
		      wrap=FALSE) +
    labs(title = 'Stage: {closest_state}') +
    enter_fade() +
    exit_fade() +
    ease_aes("linear")
p.anim <- animate(p)
anim_save("fancyTSNE.gif",animation=p.anim)

# p <- ggplot(pD, aes(x=UMAP1, y=UMAP2, color=ClusterLabels)) +
#     geom_point() +
#     transition_states(ranktumorTime,
#                       transition_length=tranTimes,
#                       state_length=1,
#                       wrap=FALSE) +
#     labs(title = 'Stage: {closest_state}') +
#     enter_fade() +
#     exit_fade() +
#     ease_aes("linear")
# p.anim <- animate(p)
# anim_save("fancyUMAP.gif",animation=p.anim)
```

# Circumstantial evidence supporting the tumor time

1. It correlates with the age of the animals.
   - Only one WKBR65.3i (38 weeks) is assigned a higher score than the two 41 week old animals. However, for this animal the animal care taker thought to have felt a mass that we were unable to see when dissecting the animal. Further, just by visual inspection there are many hints that this animal looks closer to tumor than WT.

2. Tumor cells are only present in the last three samples of the ordering (including WKBR65.3i).

3. The ERneg compartment shows a gradual shift from the normal LP (C19A) phenotype towards the LP-Av (C19B) phenotype that we described before.

```{r, message=FALSE}
summry <- group_by(pD, ranktumorTime, SubClusterLabels) %>%
    summarize(n=n()) %>%
    filter(SubClusterLabels %in% c("C19A","C19B"), ranktumorTime!=8) %>%
    group_by(ranktumorTime) %>%
    mutate(n=n/sum(n))
ggplot(summry, aes(x=ranktumorTime,y=n,fill=SubClusterLabels)) +
    geom_bar(stat="identity") +
    xlab("Tumor Stage") +
    ylab("Prcntg of C19")
```

# Validating the tumor time
- In order to get an external validation of the inferred tumor time we will select a subset of genes that correlates strongly with PC1 (in bulk) and extract RNA from animals to perform bulk qPCR.

```{r, message=FALSE}
# pD.sub <- pD[pD$ranktumorTime!=8 &pD$ClusterLabels=="C19",]
# m.sub <- m[,pD.sub$barcode]
# m.sub <- m.sub[rowMeans(m.sub)>0.01,]
# out <- data.frame(numeric(nrow(m.sub)))
# colnames(out) <- levels(factor(pD.sub$ranktumorTime))[1]
# for (cond in levels(factor(pD.sub$ranktumorTime))) {
#     expr <- rowMeans(m.sub[,pD.sub$ranktumorTime==cond])
#     colname <- cond
#     out[,colname] <- expr
# }
# rownames(out) <- rownames(m.sub)
# library(limma)
# require(viridis)
# design <- model.matrix(~as.numeric(levels(factor(pD.sub$tumorTime)))) #dirty
# fit <- lmFit(out, design)
# fit <- treat(fit, robust=TRUE, trend=TRUE,lfc=log2(1.2))
# top <- topTreat(fit,coef=2,n=5000)
# overviewPlot(m.sub,pD.sub,"Foxc1",variable="ranktumorTime")

# Changes along tumor time
# bubblePlot(m.sub,markers=rownames(top[1:100,]),pD.sub$ranktumorTime,cluster_col=FALSE)
```

## Global Changes 
- Overview over how the tSNE changes along tumor time as a gif looping through the 8 different stages.
![Animated tSNE](fancyTSNE.gif)
<!-- ![Animated UMAP](fancyUMAP.gif) -->


```{r, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
# Compute changes in tSNE per cluster
pD.smp <- group_by(pD,ranktumorTime) %>%
    sample_n(5242) %>%
    ungroup
pltlist <- list()
for (clust in unique(pD$ClusterLabels)) {
    cells <- pD$barcode[pD$ClusterLabels==clust]
    pD.sub <- pD[cells,]

pltlist[[clust]] <- ggplot(pD.sub, aes(x=Sub.tSNE1, y=Sub.tSNE2, color=SubClusterLabels)) +
	geom_point() +
	geom_density_2d(color="black") +
	facet_wrap(~ranktumorTime) +
	ggtitle(clust)
}
```
## Myeloid cells

- __Important to note that the ordering comes from these cells, so that we see gradual changes should not be a surprise__
- The most obvious changes can be observed in __C3 (Macrophage)__ and __C16 (DCs)__

### Frequency over time
- Changes of myeloid cluster frequency over tumor time
- Frequencies denoted as per total cells of a sample 

```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C2","C3","C16","C20")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
summry <- group_by(pD, ranktumorTime, ClusterLabels) %>%
    summarize(n=n()) %>%
    mutate(freq=n/sum(n)) %>%
    filter(ClusterLabels %in% clust) %>%
    as.data.frame()
summry$freq <- summry$freq * 100
ggplot(summry, aes(x=ranktumorTime, y=freq, group=ClusterLabels,color=ClusterLabels)) +
    geom_smooth() +
    geom_point() +
    facet_wrap(~ClusterLabels) +
    ylim(c(-5,40))
```

#### C3 (Macrophages)
- Subcluster D appears to be a "steady-state" that is present in the normal gland.
- Subclusters A, B, C are related to tumor progression. Assumingly represent an activation state.
- They are all fairly similiar yet show enough differences to be considered seperate clusters.

__Subcluster and their frequncies__
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C3")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
summry <- group_by(pD.sub, ranktumorTime, SubClusterLabels) %>%
    summarize(n=n()) %>%
    mutate(freq=n/sum(n)) %>%
    as.data.frame()
summry$freq <- summry$freq * 100
ggplot(summry, aes(x=ranktumorTime, y=freq, group=SubClusterLabels,color=SubClusterLabels)) +
    geom_smooth(size=2) +
    geom_point() +
    ylim(c(-1,101))
```

__Heatmap of marker genes for the various subclusters__

```{r, fig.width=3, fig.height=9, warning=FALSE, message=FALSE}
clust <- c("C3")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
m.sub <- m[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]
m.sub <- m.sub[rownames(m.sub) %in% fD$uniqnames[fD$KeepForHvg],]
markers <- findMarkers(m.sub,factor(pD.sub$SubClusterLabels),direction="up")
markers <- lapply(markers,data.frame)
markers <- unique(unlist(lapply(markers,function(x) head(rownames(x),30))))
bubblePlot(m.sub, markers, factor(pD.sub$SubClusterLabels))
```



- Ly6a (Sca-1) might be suitable surface marker to mark A, B and C
```{r, fig.width=7, fig.height=7, warning=FALSE, message=FALSE}
gene <- "Ly6a"
exps <- data.frame(gene=m.sub[gene,],
		   barcode=colnames(m.sub))
colnames(exps)[1] <- gene
pD.sub <- left_join(pD.sub,exps)
p0 <- ggplot(pD.sub, aes_string(x="SubClusterLabels", y=gene, fill="SubClusterLabels")) +
    geom_boxplot() +
    theme(legend.position="none",
	  axis.text=element_text(size=7))
p1 <- ggplot(pD.sub, aes_string(x="Sub.tSNE1",y="Sub.tSNE2",color=gene)) +
    geom_point() +
    scale_color_viridis() +
    theme(legend.position="bottom",legend.direction="horizontal")
plot_grid(p1,p0,rel_widths=c(1,0.5))
```

#### C2 (Neutrophils)
- Generally expands towards tumor formation but less so than C3 (generally fewer cells as well).
- One sub-cluster that appears to be present in all stages (C3C) and two cluster that are expanded in the tumor (C2A,C2B).
- The small subcluster might also be a different cell type altogether? Does not express S100a8 which I used to identify them as neutrophils.

__Sub Clusters and their frequency__
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
subPlot(m,pD,"C2","SubClusterLabels")
clust <- c("C2")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
summry <- group_by(pD.sub, ranktumorTime, SubClusterLabels) %>%
    summarize(n=n()) %>%
    mutate(freq=n/sum(n)) %>%
    as.data.frame()
summry$freq <- summry$freq * 100
ggplot(summry, aes(x=ranktumorTime, y=freq, group=SubClusterLabels,color=SubClusterLabels)) +
    geom_smooth(size=2) +
    geom_point() +
    ylim(c(-1,100))
```

__Heatmap of subclusters__

- Ccrl2 is up in the tumor neutrophils appears to be required for neutrophil recruitment ([http://www.bloodjournal.org/content/130/10/1223?sso-checked=true])
- Curiously they also up-regulated DNA-Damage response genes (e.g. Cdkn1a or Gadd45b) 
  - This might be due to produciton of ROS or something else?
- Interesting is also G0s2 ("The G0/G1 switch gene 2 (G0S2) was originally identified in blood mononuclear cells following induced cell cycle progression.")
- Mif apparently recruits neutrophils
```{r, fig.width=3, fig.height=9, warning=FALSE, message=FALSE}
clust <- c("C2")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
m.sub <- m[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]
m.sub <- m.sub[rownames(m.sub) %in% fD$uniqnames[fD$KeepForHvg],]
markers <- findMarkers(m.sub,factor(pD.sub$SubClusterLabels),direction="up")
markers <- lapply(markers,data.frame)
markers <- unique(unlist(lapply(markers,function(x) head(rownames(x),20))))
bubblePlot(m.sub, markers, factor(pD.sub$SubClusterLabels))
```

#### C16 (DCs)
- Dendritic cells also show an interesting pattern
- the bottom right corner (C16D) might represent DC being activated and migrating to lymph node to present Ag, express Ccr7
- C16D shows a relative increase in tumor formation and C16A goes down (also note that in the diffusion map the left most corner becomes less occupied towards tumor formation)
- displayed here as diffusion maps, that seems quite nice

__Sub Clusters and their frequency__
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
subPlot(m,pD,"C16","SubClusterLabels")
clust <- c("C16")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
summry <- group_by(pD.sub, ranktumorTime, SubClusterLabels) %>%
    summarize(n=n()) %>%
    mutate(freq=n/sum(n)) %>%
    as.data.frame()
summry$freq <- summry$freq * 100
ggplot(summry, aes(x=ranktumorTime, y=freq, group=SubClusterLabels,color=SubClusterLabels)) +
    geom_smooth(size=2) +
    geom_point() +
    ylim(c(-1,80))
```

```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C16"
pD.sub <- pD[pD$ClusterLabels==clust,]
m.sub <- m[,pD.sub$barcode]
hvg <- getHighVar(m.sub,get.var.out=TRUE,supress.plot=TRUE)
hvg <- hvg[(rownames(hvg) %in% fD$uniqnames[fD$KeepForHvg]),] 
hvg <- rownames(hvg[order(hvg$bio, decreasing=TRUE),])[1:(nrow(hvg)/20)]
library(destiny)
set.seed(300)
dm <- DiffusionMap(as.matrix(t(m.sub[hvg,])),rotate=TRUE)
dms <- eigenvectors(dm)
pD.sub$DC1 <- dms[,1]
pD.sub$DC2 <- dms[,2]
pD.sub$DC3 <- dms[,3]
ggplot(pD.sub, aes(x=DC1,y=DC2,color=SubClusterLabels)) +
    geom_point() + 
    facet_wrap(~ranktumorTime)
overviewPlot(m.sub, pD.sub, "Ccr7", dim1="DC1", dim2="DC2", variable="SubClusterLabels")
```


__Heatmap of subclusters__
```{r, fig.width=3, fig.height=9, warning=FALSE, message=FALSE}
clust <- c("C16")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
m.sub <- m[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]
m.sub <- m.sub[rownames(m.sub) %in% fD$uniqnames[fD$KeepForHvg],]
markers <- findMarkers(m.sub,factor(pD.sub$SubClusterLabels),direction="up")
markers <- lapply(markers,data.frame)
markers <- unique(unlist(lapply(markers,function(x) head(rownames(x),20))))
bubblePlot(m.sub, markers, factor(pD.sub$SubClusterLabels))
```

## T-Cells
- C1 shows an early increase in the BRCA1 model and then dissappears with the appearences of the tumor and is apparently replaced by C10.
- Looking at this again, the frequency of the clusters does vary a lot and might not be too convincing to talk about a gradual change of their frequencies
- Sample 6 is a bit of a weird one it just generally has more of both.

__Frequency over time__
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C1","C10")
summry <- group_by(pD, ranktumorTime, ClusterLabels) %>%
    summarize(n=n()) %>%
    mutate(freq=n/sum(n)) %>%
    filter(ClusterLabels %in% clust) %>%
    as.data.frame()
summry$freq <- summry$freq * 100
ggplot(summry, aes(x=ranktumorTime, y=freq, group=ClusterLabels,color=ClusterLabels)) +
    geom_smooth() +
    geom_point() +
    facet_wrap(~ClusterLabels) +
    ylim(c(0,40))
```


__Frequency of Subclusters__
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C1","C10")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
summry <- group_by(pD, ranktumorTime, ClusterLabels, SubClusterLabels) %>%
    summarize(n=n()) %>%
    mutate(freq=n/sum(n)) %>%
    filter(ClusterLabels %in% clust) %>%
    as.data.frame()
summry$freq <- summry$freq * 100
ggplot(summry, aes(x=ranktumorTime, y=freq, group=SubClusterLabels,color=SubClusterLabels)) +
    geom_smooth(lwd=2) +
    geom_point() +
    facet_wrap(~ClusterLabels) +
    ylim(c(-10,110))
```

__Heatmap of subclusters__
```{r, fig.width=4, fig.height=10, warning=FALSE, message=FALSE}
clust <- c("C1","C10")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
m.sub <- m[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]
m.sub <- m.sub[rownames(m.sub) %in% fD$uniqnames[fD$KeepForHvg],]
markers <- findMarkers(m.sub,factor(pD.sub$SubClusterLabels),direction="up")
markers <- lapply(markers,data.frame)
markers <- unique(unlist(lapply(markers,function(x) head(rownames(x),30))))
bubblePlot(m.sub, markers, factor(pD.sub$SubClusterLabels))
```

## Stroma

- C6, C13 and C9 all decrease in frequency. This might be due to expansion of the luminal compartment?
The (supposably) CAFs (C5) also only start to appear close to tumor formation.
- C5 has some substructure that I need to look into in more detail. Also contains a potential doublet cluster with macrophage markers (or CAFs being phagocytosed?)

### Cluser frequeny over time
- Changes of stromal cluster frequency over tumor time
- Frequencies denoted as per total cells of a sample 

```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C5","C6","C8","C9","C13")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
summry <- group_by(pD, ranktumorTime, ClusterLabels) %>%
    summarize(n=n()) %>%
    mutate(freq=n/sum(n)) %>%
    filter(ClusterLabels %in% clust) %>%
    as.data.frame()
summry$freq <- summry$freq * 100
ggplot(summry, aes(x=ranktumorTime, y=freq, group=ClusterLabels,color=ClusterLabels)) +
    geom_smooth() +
    geom_point() +
    ylim(c(-1,30))
```

__Heatmap of Clusters__
```{r, fig.width=3, fig.height=9, warning=FALSE, message=FALSE}
clust <- c("C5","C6","C8","C9","C13")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
m.sub <- m[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]
m.sub <- m.sub[rownames(m.sub) %in% fD$uniqnames[fD$KeepForHvg],]
markers <- findMarkers(m.sub,factor(pD.sub$ClusterLabels),direction="up")
markers <- lapply(markers,data.frame)
markers <- unique(unlist(lapply(markers,function(x) head(rownames(x),30))))
bubblePlot(m.sub, markers, factor(pD.sub$ClusterLabels))
```

- We can also see the shift in the fibroblast compartment as visualized by a diffusion map (result from PCA isn't too different)
- It sort of gradually shifts from the left side along DC1 to the right side (also shown as density plots below where you can better appreciate the shift in populations)
- However, looking at this in more detail I am not too impressed, the shift is only really apparent in samples 7 and 8, which came from the same animal even though one is tumor one is not.
- Sample 6 also shows some shift but not too impressive
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C5","C6","C8","C9","C13")
pD.sub <- pD[pD$ClusterLabels==clust & pD$SubClusterLabels!="C5C",]
m.sub <- m[,pD.sub$barcode]
hvg <- getHighVar(m.sub,get.var.out=TRUE,supress.plot=TRUE)
hvg <- hvg[(rownames(hvg) %in% fD$uniqnames[fD$KeepForHvg]),] 
hvg <- rownames(hvg[order(hvg$bio, decreasing=TRUE),])[1:(nrow(hvg)/20)]
library(destiny)
set.seed(300)
dm <- DiffusionMap(as.matrix(t(m.sub[hvg,])),rotate=TRUE)
dms <- eigenvectors(dm)
pD.sub$DC1 <- dms[,1]
pD.sub$DC2 <- dms[,2]
pD.sub$DC3 <- dms[,3]
ggplot(pD.sub, aes(x=DC1,y=DC2,color=SubClusterLabels)) +
    geom_point() + 
    facet_wrap(~ranktumorTime)
ggplot(pD.sub, aes(x=DC1,y=..scaled..)) +
    geom_density() + 
    facet_wrap(~ranktumorTime)
```


## Epithelium
The ER- compartment generally expands (C19) before tumor formation and then disappears in the tumor. Basals relatively decrease during the same time. HRS (C14) are flat. Tumor epithelium is only present in the last three samples.

```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C19","C14","C4","C12")
pD.sub <- pD[pD$ClusterLabels %in% clust,]
summry <- group_by(pD, ranktumorTime, ClusterLabels) %>%
    summarize(n=n()) %>%
    mutate(freq=n/sum(n)) %>%
    filter(ClusterLabels %in% clust) %>%
    as.data.frame()
summry$freq <- summry$freq * 100
ggplot(summry, aes(x=ranktumorTime, y=freq, group=ClusterLabels,color=ClusterLabels)) +
    geom_smooth(lwd=2)  +
    geom_point()
```

- Based on visual inspection in the diffusion maps, it seems that the transitions between basal and luminal are more frequent in the BRCA1 animal and might even become more frequent with stage
- In the density plots underneath you can better appreciate how in the WT (Stage 1) basal and luminal are quite well separated and then in the BRCA1 animals the both peaks become wider and closer to each other
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C19","C12")
pD.sub <- pD[pD$ClusterLabels %in% clust & pD$ranktumorTime !=8,]
m.sub <- m[,pD.sub$barcode]
hvg <- getHighVar(m.sub,get.var.out=TRUE,supress.plot=TRUE)
hvg <- hvg[(rownames(hvg) %in% fD$uniqnames[fD$KeepForHvg]),] 
hvg <- rownames(hvg[order(hvg$bio, decreasing=TRUE),])[1:(nrow(hvg)/20)]
library(destiny)
set.seed(300)
dm <- DiffusionMap(as.matrix(t(m.sub[hvg,])),rotate=TRUE)
dms <- eigenvectors(dm)
pD.sub$DC1 <- dms[,1]
pD.sub$DC2 <- dms[,2]
pD.sub$DC3 <- dms[,3]
ggplot(pD.sub, aes(x=DC1,y=DC2)) +
    geom_point() +
facet_wrap(~ranktumorTime)

pD.sub <- arrange(pD.sub, desc(ranktumorTime))
ggplot(pD.sub, aes(x=DC1, y=..scaled..,fill=ranktumorTime)) +
    geom_density()+ 
    facet_wrap(~ranktumorTime)
```

## Expression changes per cluster 
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE, cache=TRUE}
coi.full <- as.matrix(as.data.frame.matrix((table(pD$ClusterLabels,pD$ranktumorTime))))
coi.full <- coi.full[,c(1:7)]
coi <- coi.full[rowSums(coi.full<=5)<2,]
```
- Next, I investigated linear changes in expression over tumor time in clusters that were present with at least 50 cells in all timepoints (hence __excluding__ `r setdiff(rownames(coi.full),rownames(coi))`) This analysis excluded the tumor sample.

#### Notes
- Particularly interesting might be the ER- compartmet which shows increasing expression of milk genes (as expected) as well as deregulation of several genes involved in cell cycle arrest, DNA damage etc.
- In addition, one fibroblast cluster also shows very strong effects.
- It is important to note that this very much depends on the definition of the clusters, if a celltype changes so much that it is considered a different cluster this will not be captured here, this is why I looked at all the distribution of subclusters, grouped cells by inferred cell type etc.

```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE, cache=TRUE}
out <- data.frame()
tps <- list()
for (cluster in rownames(coi)) {
    cells <- pD$barcode[pD$ClusterLabels==cluster & !pD$ranktumorTime %in% c(8)]
    pD.sub <- pD[cells,]
    m.sub <- m[,cells]
    m.sub <- as.matrix(m.sub[rowMeans(m.sub)>0.01 & rownames(m.sub) %in% fD$uniqnames[fD$KeepForHvg],])
    library(limma)
    require(viridis)
    design <- model.matrix(~pD.sub$tumorTime)
    fit <- lmFit(m.sub, design)
    fit <- treat(fit, robust=TRUE, trend=TRUE,lfc=log2(1.2))
    genesUp <- summary(decideTests(fit,coef=2))[,2][3]
    genesDown <- summary(decideTests(fit,coef=2))[,2][1]
    tmp  <- data.frame(rbind(c(genesUp,"Up"),c(genesDown,"Down")))
    colnames(tmp) <- c("DE","Type")
    tmp$Cluster <- cluster
    tps[[cluster]] <- topTreat(fit,n=nrow(m.sub),coef=2)
    out <- rbind(out,tmp)
}
out$DE <- as.numeric(as.character(out$DE))
ggplot(out, aes(x=Cluster, y=DE, fill=Type)) +
    geom_bar(stat="identity")
```



```{r, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
# GO Analaysis
# deGenes <- rownames(tops)[tops$logFC>0 &tops$adj.P.Val<0.01]
# univrs <- rownames(tops)
# alG <- factor(as.numeric(univrs %in% deGenes))
# names(alG) <- univrs
# library(topGO)
# GO.data <- new("topGOdata", description="Lib GO",ontology="BP", allGenes=alG, 
#                annot=annFUN.org, mapping="org.Mm.eg.db",
#                nodeSize=20, ID="symbol")
# result.classic <- runTest(GO.data, statistic="fisher")
# tmp <- GenTable(GO.data, Fisher.classic=result.classic, orderBy="topgoFisher", topNodes=50, numChar=300)
# head(tmp,30)




# cells <- pD$barcode[pD$ClusterLabels==clust & !pD$ranktumorTime %in% c(8)]
# pD.sub <- pD[cells,]
# m.sub <- m[,cells]
# gene <- "Plet1"
# exps <- data.frame(gene=m.sub[gene,],
#                     barcode=colnames(m.sub))
# colnames(exps)[1] <- gene
# pD.sub <- left_join(pD.sub,exps)
# p0 <- ggplot(pD.sub, aes_string(x="ranktumorTime", y=gene, fill="ranktumorTime")) +
#     geom_boxplot() +
#     theme(legend.position="none",
#           axis.text=element_text(size=7))
# print(p0)

#     m.sub <- m.sub[rownames(tps[[cluster]])[1:50],]
#     mean.exp <- data.frame(numeric(nrow(m.sub)))
#     colnames(mean.exp) <- levels(factor(pD.sub$ranktumorTime))[1]
#     for (tmn in levels(factor(pD.sub$ranktumorTime))) {
#         expr <- apply(m.sub[,pD.sub$ranktumorTime==tmn],1,mean)
#         colname <- tmn
#         mean.exp[,colname] <- expr
#     }
#     mean.exp <- mean.exp-mean.exp[,1]
#     rownames(mean.exp) <- rownames(m.sub)
#     library(pheatmap)
#     pheatmap(mean.exp,
#              cluster_cols=FALSE,
#              clustering_distance_rows="euclidean",
#              clustering_method="ward.D2",
#              main=paste0("Top 50 DE genes for ",cluster),
#              fontsize=8)
```
