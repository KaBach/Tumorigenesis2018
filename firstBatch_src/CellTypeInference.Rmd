---
title: "BRCA1 cell type inference"
author: "Karsten Bach"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: united
    highlight: tango
    code_folding: hide
---
***

```{r, message=FALSE,warning=FALSE}
library(scran)
library(scater)
library(plyr)
library(dplyr)
library(knitr)
library(ggplot2)
library(Rtsne)
library(cowplot)
library(Matrix)
library(gridExtra)
library(pheatmap)
library(irlba)
source("functions.R")

dataList <- readRDS("../data/Robjects/ExpressionList_QC.rds")
sfs <- read.csv("../data/Robjects/SizeFactors.csv")
m <- dataList[["counts"]]
pD <- dataList[["phenoData"]]
pD <- left_join(pD,sfs)
fD <- dataList[["featureData"]]
rm(dataList)

umap <- read.csv("../data/Robjects/UMAP_all.csv")
anno <- read.csv("../data/Robjects/Cluster_final.csv")[,-1]
pD <- right_join(pD,umap)
pD <- left_join(pD,anno)

m <- m[,pD$barcode]
m <- log2(t(t(m)/pD$sf)+1)
m <- as(m,"dgCMatrix")
keepgenes <- fD$uniqnames[fD$KeepForHvg]

m.full <- m[rownames(m) %in% keepgenes,]
fD <- fD[rowMeans(m)>0.01 & fD$uniqnames %in% keepgenes,]
m <- m[rowMeans(m)>0.01 & rownames(m) %in% keepgenes,]

```

# Cell type Inference 
After having compared cell type inference with or without tumor, we have decided to infer cell types with the tumor sample included as this yielded satisfactory results and will facilitate comparisons later one between tumor and non-tumor samples.

## UMAP
```{r, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster)) +
    geom_point() +
    ggtitle("Cluster") 
```

__Similarity of Clusters__
- This overall similarity works quite nicely in reflecting the different lineages that we captured.
- The bottom group are all immune cells, with the top one (C3-C18) being myeloid and the bottom one (C15-C7) lymphoid
- The top group conntains epithelial cells (luminal C4,C13,C17, basal C11) and stromal cells
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- levels(pD$FinalCluster)
pD.sub <- pD[pD$FinalCluster %in% clust,]
m.sub <- m[,pD.sub$barcode]

pD.sub$FinalCluster <- factor(pD.sub$FinalCluster) #drop unused levels
out <- data.frame(numeric(nrow(m.sub)))
colnames(out) <- levels(pD.sub$FinalCluster)[1]
for (clust in levels(pD.sub$FinalCluster)) {
    expr <- rowMeans(m.sub[,pD.sub$FinalCluster==clust])
    colname <- clust
    out[,colname] <- expr
}

library(dendextend)
dis <- as.dist((1-cor(out,method="spearman"))/2)
dendr <- dis %>% hclust(.,method="ward.D2") %>% as.dendrogram %>%
    set("leaves_pch",19) %>%
    set("leaves_cex",2) %>%
    set("branches_lwd",3)
# par(cex=.6)
plot(dendr,horiz=TRUE,yaxt="n")
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
overviewPlot <- function(m,pD,cluster,gene,
			 dim1="UMAP1",dim2="UMAP2",
			 variable="FinalCluster") {
    require(cowplot)
    require(viridis)
    exps <- data.frame(gene=m[gene,],
			barcode=colnames(m))
    colnames(exps)[1] <- gene
    pD <- left_join(pD,exps)
    p0 <- ggplot(pD, aes_string(x=variable, y=gene, fill=variable)) +
	geom_boxplot() +
	coord_flip() +
	theme(legend.position="none",
	      axis.text=element_text(size=7))

    p1 <- ggplot(pD, aes_string(x=dim1, y=dim2, color=gene)) +
	geom_point() +
	theme_void() +
	ggtitle(gene) +
	scale_color_viridis()

    pout <- plot_grid(p1,p0,nrow=1)
    return(pout)
}
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, cache=TRUE, results="hide"}
markers <- findMarkers(m,pD$FinalCluster,direction="up",pval.type="all")
sapply(names(markers),function(x) write.csv(markers[[x]],file=paste0("../data/misc/marker/",x,".csv")))
```

# Immune Cells
- All cells in turquoise
- All Cd45 positive (C2 and C18 are not, but express other markers of their respective lineages)
```{r, fig.width=7, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C1","C2","C3","C5","C6","C4","C28","C29","C30","C32","C31","C33",
	   "C19","C20","C21","C15","C13","C9","C44")
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster %in% clust)) +
    geom_point() +
    theme_void() +
    theme(legend.position="none") 

pD.sub <- pD[pD$FinalCluster %in% clust,]
m.sub <- m.full[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]
overviewPlot(m, pD, gene="Ptprc")
overviewPlot(m, pD, gene="Cd19")

markers <- findMarkers(m.sub,factor(pD.sub$FinalCluster),direction="up",pval.type="all")

pD.sub$FinalCluster <- factor(pD.sub$FinalCluster) #drop unused levels
out <- data.frame(numeric(nrow(m.sub)))
colnames(out) <- levels(pD.sub$FinalCluster)[1]
for (clusts in levels(pD.sub$FinalCluster)) {
    expr <- rowMeans(m.sub[,pD.sub$FinalCluster==clusts])
    colname <- clusts
    out[,colname] <- expr
}

library(dendextend)
dis <- as.dist((1-cor(out,method="spearman"))/2)
dendr <- dis %>% hclust(.,method="ward.D2") %>% as.dendrogram %>%
    set("leaves_pch",19) %>%
    set("leaves_cex",2) %>%
    set("branches_lwd",3)
# par(cex=.6)
plot(dendr,horiz=TRUE,yaxt="n")
```

## C1 is a T-Cell cluster

- Expresses the co-stimulatory marker Cd28
- Uncertain whether the T-Cell clusters make sense
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C1"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:50,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)

print(overviewPlot(m,pD,clust,"Cd28"))
ctc <- c("C1"="Tc1")
```


## C2 are neutrophils
- Cd14 positive
- Expresses high levels of the alarmin s100a8/a9, which is a biomarker for local inflammation (https://www.nature.com/articles/ncomms5593.pdf). It is highly enriched in the tumor.
- other markers include: Slfn4 (a gene that supposably marks MDSCs (https://www.jci.org/articles/view/82529/pdf) in gastric metaplasia)
- Slfn4 is particularly interesting as it's expression in this cluster is restricted to animals that have or almost have tumors
- These are neutrophils according to (http://cancerimmunolres.aacrjournals.org/content/canimm/early/2014/05/06/2326-6066.CIR-13-0209.full.pdf)
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C2"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:40,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"S100a8"))
print(overviewPlot(m,pD,clust,"Cd14"))
ctc <- c(ctc,"C2"="Np")
```

## C3 is a basophil cluster

- This Cluster is present at low frequency across all samples
- was previously clustered with C2 but seems to be different
- maybe basophil?
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C3"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
# markedby <- markers[[clust]]
# markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
# mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:60,]
# colnames(mheat) <- gsub("logFC.","",colnames(mheat))
# pheatmap(mheat,
#          cluster_rows=FALSE,
#          cluster_cols=FALSE,
#          show_colnames=TRUE,
#          fontsize=7)
print(overviewPlot(m.full,pD,clust,"Gata2"))
print(overviewPlot(m.full,pD,clust,"Mcpt8"))
ctc <- c(ctc,"C3"="Bp")
```

## C4 is a tumor associated macrophage cluster
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C4"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
# markedby <- markers[[clust]]
# markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
# mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[40:80,]
# colnames(mheat) <- gsub("logFC.","",colnames(mheat))
# pheatmap(mheat,
#          cluster_rows=FALSE,
#          cluster_cols=FALSE,
#          show_colnames=TRUE,
#          fontsize=7)
print(overviewPlot(m,pD,clust,"Adgre1"))
ctc <- c(ctc,"C4"="Tam1")
```

## C5 is a tumor associated macrophage cluster
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C5"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Adgre1"))
ctc <- c(ctc,"C5"="Tam2")
```

## C6 is a macrophage cluster
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C6"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:30,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Adgre1"))
ctc <- c(ctc,"C6"="Mp1")

```

## C9 is a doublet of macrophage and tumor cells
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C9"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:10,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Adgre1"))
print(overviewPlot(m,pD,clust,"Epcam"))
ctc <- c(ctc,"C9"="Db1")
```

## C13 is a doublet of macrophages with fibroblasts
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C13"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:50,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Adgre1"))
print(overviewPlot(m,pD,clust,"Col1a1"))
ctc <- c(ctc,"C13"="Db2")
```

## C15 is a plasma cell
- This cluster expresses high levels of Jchain and Mzb1. It lacks however the B-Cellmarker Cd19 and Cd72. It is present at a low frequency in all samples apart from the tumour and the other gland of the tumour animal.
- Expresses part of BCR (Cd79a).
- Identified it as plasma cell based on expression of blimp1 (Prdm1), Xbp1 and lack of Cd19 is apparently also common on plasma cells, and it has really high levels of Jchain
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C15"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Jchain"))
print(overviewPlot(m,pD,clust,"Cd79a"))
print(overviewPlot(m,pD,clust,"Prdm1"))
ctc <- c(ctc,"C15"="Pc")
```

## C19 is a T-Cell Cluster
- might be exhausted Tcs?
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C19"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
ctc <- c(ctc,"C19"="Tc2")
```

## C20 is a doublet of basal and macrophage
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C20"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Adgre1"))
print(overviewPlot(m,pD,clust,"Krt5"))
ctc <- c(ctc,"C20"="Db3")
```

## C21 is a doublet of basal and B-Cells
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C21"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Krt5"))
print(overviewPlot(m,pD,clust,"Cd79a"))
# print(overviewPlot(m,pD,clust,"Sec61a1"))
ctc <- c(ctc,"C21"="Db4")
```

## C28 is a T-cell cluster
- Also contains NK cells, needs subclustering
- Marked by Gzma, Gzmb, Xcl1 expression.
- Also Irf8.
- Express the NK-cell receptor Klrd1, and also very low levels of Ly49(Klra1).
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C28"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Krt5"))
print(overviewPlot(m,pD,clust,"Cdc25a"))
print(overviewPlot(m,pD,clust,"Gzma"))
print(overviewPlot(m,pD,clust,"Xcl1"))
# print(overviewPlot(m,pD,clust,"Sec61a1"))
ctc <- c(ctc,"C28"="Tc3")
```

## C29 is a B-cell cluster
- Expresses part of BCR (Cd79a).
- Ebf1 is an interesting one. It's also expressed in Fbs and controls adipogenesis apparently.
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C29"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Cd79a"))
ctc <- c(ctc,"C29"="Bc")
```

## C30 are migratory DCs
- Expresses Ccr7
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C30"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Ccr7"))
print(overviewPlot(m,pD,clust,"Irf8"))
ctc <- c(ctc,"C30"="mDc")
```

## C32 are dendritic cells
- Ccr2 high
- Adgre1 negative
- __NEEDS VALIDATION__
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C32"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Ccr2"))
#print(overviewPlot(m.full,pD,clust,"Itgam_ENSMUSG00000030786"))
ctc <- c(ctc,"C32"="DcPot")
```

## C31 are macrophages
- Retnla high
- Express the two TAM marker Cd163 and Cd206(Mrc1) but are mostly found in WT
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C31"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:37,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Retnla"))
print(overviewPlot(m,pD,clust,"Adgre1"))
print(overviewPlot(m.full,pD,clust,"Cd163"))
print(overviewPlot(m.full,pD,clust,"Mrc1"))
ctc <- c(ctc,"C31"="Mp2")
```

## C33 are dendritic cells
- Cd209a positive
- also contains pDCs (Siglech+)
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C33"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:nrow(markedby),]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
# print(overviewPlot(m,pD,clust,"Itgae"))
print(overviewPlot(m,pD,clust,"Cd209a"))
print(overviewPlot(m.full,pD,clust,"Siglech"))
ctc <- c(ctc,"C33"="Dc209")
```

## C44 are monocytes
- High levels of MHC-II
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C44"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:7,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
# print(overviewPlot(m,pD,clust,"Itgae"))
print(overviewPlot(m,pD,clust,"Adgre1"))
print(overviewPlot(m,pD,clust,"Lyz2"))
print(overviewPlot(m,pD,clust,"Epcam"))
ctc <- c(ctc,"C44"="Mcs")
```

# Epithelium

```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C8","C7","C42","C43","C27","C22","C22")
	   
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster %in% clust)) +
    geom_point() +
    theme_void() +
    theme(legend.position="none") 

pD.sub <- pD[pD$FinalCluster %in% clust,]
m.sub <- m.full[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]

markers <- findMarkers(m.sub,factor(pD.sub$FinalCluster),direction="up",pval.type="all")

pD.sub$FinalCluster <- factor(pD.sub$FinalCluster) #drop unused levels
out <- data.frame(numeric(nrow(m.sub)))
colnames(out) <- levels(pD.sub$FinalCluster)[1]
for (clusts in levels(pD.sub$FinalCluster)) {
    expr <- rowMeans(m.sub[,pD.sub$FinalCluster==clusts])
    colname <- clusts
    out[,colname] <- expr
}

library(dendextend)
dis <- as.dist((1-cor(out,method="spearman"))/2)
dendr <- dis %>% hclust(.,method="ward.D2") %>% as.dendrogram %>%
    set("leaves_pch",19) %>%
    set("leaves_cex",2) %>%
    set("branches_lwd",3)
# par(cex=.6)
plot(dendr,horiz=TRUE,yaxt="n")
```

## C8 are tumor cells
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C8"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:50,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
# print(overviewPlot(m,pD,clust,"Itgae"))
print(overviewPlot(m,pD,clust,"Tes"))
print(overviewPlot(m,pD,clust,"Inhba"))
ctc <- c(ctc,"C8"="Tm1")
```

## C7 are tumor cells
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C7"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:50,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
# print(overviewPlot(m,pD,clust,"Itgae"))
ctc <- c(ctc,"C7"="Tm2")
```

## C43 are Lps
- Lps
- also contains the "intermediate population
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C43"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:10,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Aldh1a3"))
print(overviewPlot(m,pD,clust,"Xist"))
ctc <- c(ctc,"C43"="Lp")
```

## C42 are alveolar cells
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C42"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:10,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Wap"))
print(overviewPlot(m,pD,clust,"Csn2"))
ctc <- c(ctc,"C42"="Av")
```

## C27 are hormone-sensing cells
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C27"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Prlr"))
ctc <- c(ctc,"C27"="Hs")
```

## C22 are basal cells
- also contains doublets with Fbs
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C22"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Krt5"))
ctc <- c(ctc,"C22"="Bsl")
```

# Stroma

```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- c("C10","C11","C12","C14","C16","C17","C18",
	   "C23","C24","C25","C26","C34","C35","C36","C37","C38","C39",
	   "C40","C41")
	   
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster %in% clust)) +
    geom_point() +
    theme_void() +
    theme(legend.position="none") 

pD.sub <- pD[pD$FinalCluster %in% clust,]
m.sub <- m.full[,pD.sub$barcode]
m.sub <- m.sub[rowMeans(m.sub)>0.01,]

markers <- findMarkers(m.sub,factor(pD.sub$FinalCluster),direction="up")

pD.sub$FinalCluster <- factor(pD.sub$FinalCluster) #drop unused levels
out <- data.frame(numeric(nrow(m.sub)))
colnames(out) <- levels(pD.sub$FinalCluster)[1]
for (clusts in levels(pD.sub$FinalCluster)) {
    expr <- rowMeans(m.sub[,pD.sub$FinalCluster==clusts])
    colname <- clusts
    out[,colname] <- expr
}

library(dendextend)
dis <- as.dist((1-cor(out,method="spearman"))/2)
dendr <- dis %>% hclust(.,method="ward.D2") %>% as.dendrogram %>%
    set("leaves_pch",19) %>%
    set("leaves_cex",2) %>%
    set("branches_lwd",3)
# par(cex=.6)
plot(dendr,horiz=TRUE,yaxt="n")
```

## C10 is a CAF cluster
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C10"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Col3a1"))
ctc <- c(ctc,"C10"="Caf1")
```

## C11 is a CAF cluster
- has some hypoxic signature (Higd1b, and Itga1 gets upregulated in hypoxia)
- Acta2 high
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C11"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Itga1"))
print(overviewPlot(m.full,pD,clust,"Higd1b"))
ctc <- c(ctc,"C11"="Caf2")
```

## C12 is a CAF cluster
- has some pathogenic matrix proteins (Tnc)
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C12"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Tnc"))
print(overviewPlot(m,pD,clust,"C1qtnf3"))
ctc <- c(ctc,"C12"="Caf3")
```

## C14 is a fibroblast cluster
- Wnt2 secreting
- Has2 expression
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C14"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m,pD,clust,"Wnt2"))
print(overviewPlot(m,pD,clust,"Has2"))
ctc <- c(ctc,"C14"="Fb1")
```

## C16 is a fibroblast cluster
- nothing very distinct, yet in terms of correlation it's very different to all other clusters. Has lower library size, might need some double checking.
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C16"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:30,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
ctc <- c(ctc,"C16"="Fb2")
```

## C17 is a fibroblast cluster
- GDF10 e.g
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C17"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:30,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m.full,pD,clust,"Fap"))
print(overviewPlot(m.full,pD,clust,"Gdf10"))
ctc <- c(ctc,"C17"="Fb3")
```

## C18 is a fibroblast cluster
- immune signature
- might be interesting, is present in all but what about changes during tumor formation?
- releases Cxcl5
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C18"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:50,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m.full,pD,clust,"Gpc3"))
print(overviewPlot(m.full,pD,clust,"Cxcl5"))
print(overviewPlot(m.full,pD,clust,"Srxn1"))
ctc <- c(ctc,"C18"="Fb4")
```

## C23 is a fibroblast cluster
- not sure if it makes sense to be kept
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C23"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
ctc <- c(ctc,"C23"="Fb5")
```

## C24 is a fibroblast cluster
- not sure if it makes sense to be kept
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C24"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
ctc <- c(ctc,"C24"="Fb6")
```

## C25 is a fibroblast cluster
- High Fos/Jun signaling
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C25"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=7)
print(overviewPlot(m.full,pD,clust,"Ccnl1"))
ctc <- c(ctc,"C25"="Fb7")
```

## C26 is a fibroblast cluster
- Interesting Cluster!
- "The authors also identified the IGFBP2/IGF1/IGF1R and GAS6/MERTK signaling pathways as regulators of cancer-mediated endothelial recruitment."
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C26"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Nos1"))
print(overviewPlot(m.full,pD,clust,"Igfbp2"))
print(overviewPlot(m.full,pD,clust,"Mme"))
ctc <- c(ctc,"C26"="Fb8")
```

## C34 are Schwann Cells
- Marked by Mbp and Mpz
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C34"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:20,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Mbp"))
print(overviewPlot(m.full,pD,clust,"Gatm"))
print(overviewPlot(m.full,pD,clust,"Gfap"))
ctc <- c(ctc,"C34"="Sc")
```

## C35 are a stromal cell type
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C35"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:40,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Agtr1a"))
ctc <- c(ctc,"C35"="Str1")
```

## C36 are vascular endothelial cells
- Igf2 secreting
- VE cadherin (Cdh5)
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C36"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:40,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Cdh13"))
print(overviewPlot(m.full,pD,clust,"Cdh5"))
ctc <- c(ctc,"C36"="Vec1")
```

## C37 are lymphatic endothelial cells
- Nts secreting
- VE cadherin (Cdh5)
- Lyve1 +
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C37"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:40,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Cdh13"))
print(overviewPlot(m.full,pD,clust,"Cdh5"))
print(overviewPlot(m.full,pD,clust,"Lyve1"))
print(overviewPlot(m.full,pD,clust,"Nts"))
ctc <- c(ctc,"C37"="Lec")
```

## C38 are pericytes 
- strong muscular signature
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C38"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:60,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Cdh5"))
print(overviewPlot(m.full,pD,clust,"Acta2"))
print(overviewPlot(m.full,pD,clust,"Notch3"))
ctc <- c(ctc,"C38"="Pyc")
```

## C39 are some stromal cells
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C39"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:60,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Cdh5"))
print(overviewPlot(m.full,pD,clust,"Eng"))
print(overviewPlot(m.full,pD,clust,"Procr"))
ctc <- c(ctc,"C39"="Str2")
```

## C40 are vascular endothelial cells
- some endothelial cell type
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C40"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:60,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Cdh5"))
print(overviewPlot(m.full,pD,clust,"Emcn"))
ctc <- c(ctc,"C40"="Vec2")
```

## C41 are vascular endothelial cells
- some endothelial cell type
```{r, fig.width=9, fig.height=5, warning=FALSE, message=FALSE}
clust <- "C41"
ggplot(pD, aes(x=UMAP1, y=UMAP2, color=FinalCluster==clust)) +
    geom_point() 
markedby <- markers[[clust]]
markedby <- markedby[apply(markedby[,c(3:ncol(markedby))],1,min)>0,]
mheat <- as.matrix(markedby[,c(3:ncol(markedby))])[1:60,]
colnames(mheat) <- gsub("logFC.","",colnames(mheat))
pheatmap(mheat,
	 cluster_rows=FALSE,
	 cluster_cols=FALSE,
	 show_colnames=TRUE,
	 fontsize=10)
print(overviewPlot(m.full,pD,clust,"Selp"))
ctc <- c(ctc,"C41"="Vec3")
```

# Doublet Confirmation

```{r, warning=FALSE, message=FALSE, cache=TRUE}
pD$CellType <- mapvalues(pD$FinalCluster,names(ctc),
			 ctc)
doublets <- data.frame(doubletCluster(m,pD$CellType))
doublets[1:5,1:5]

Doubs <- pD$barcode[pD$CellType %in% c("Db1","Db2","Db3","Db4")]
pD$IsDoublet <- pD$barcode %in% Doubs
m <- m[,!pD$IsDoublet]
pD <- pD[!pD$IsDoublet,]
pD$CellType <- factor(pD$CellType)
pD$FinalCluster <- factor(pD$FinalCluster)
```

# Summary
```{r, fig.width=5, fig.height=10, warning=FALSE, message=FALSE, cache=TRUE}
out <- data.frame(numeric(nrow(m)))
colnames(out) <- levels(factor(pD$CellType))[1]
for (clusts in levels(factor(pD$CellType))) {
    expr <- rowMeans(m[,pD$CellType==clusts])
    colname <- clusts
    out[,colname] <- expr
}

library(dendextend)
dis <- as.dist((1-cor(out,method="spearman"))/2)
dendr <- dis %>% hclust(.,method="ward.D2") %>% as.dendrogram %>%
    set("leaves_pch",19) %>%
    set("leaves_cex",2) %>%
    set("branches_lwd",3)
# par(cex=.6)
plot(dendr,horiz=TRUE,yaxt="n")
```

# Summary
```{r, fig.width=9, fig.height=7, warning=FALSE, message=FALSE, cache=TRUE}
epithelial <- c("Av","Lp","Hs","Bsl","Tm1","Tm2")
names(epithelial) <- rep("Epithelial",length(epithelial))
immune <- c("Dc209","DcPot","Tam2","Tam1","Mp1","Mp2","Mcs","Np","Bp","Bc","Pc","Tc2","Tc1","Tc3","mDc")
names(immune) <- rep("Immune",length(immune))
myeloid <- c("Dc209","DcPot","Tam2","Tam1","Mp1","Mp2","Mcs","Np","Bp","mDc")
names(myeloid) <- rep("Myeloid",length(myeloid))
lymphoid <- setdiff(immune,myeloid)
names(lymphoid) <- rep("Lymphoid",length(lymphoid))
stroma <- setdiff(levels(pD$CellType),c(epithelial,immune))
names(stroma) <- rep("Stroma",length(stroma))
endothelial <- c("Pyc","Str1","Str2","Vec1","Vec2","Vec3","Lec","Sc")
names(endothelial) <- rep("Endothelial",length(endothelial))
fibroblasts <- setdiff(stroma,endothelial)
names(fibroblasts) <- rep("Fibroblasts",length(fibroblasts))

pD$MajorGroups <- mapvalues(pD$CellType,c(epithelial,immune,stroma),
			    names(c(epithelial,immune,stroma)))

pD$Groups <- mapvalues(pD$CellType,c(epithelial,myeloid,lymphoid,fibroblasts,endothelial),
		       names(c(epithelial,myeloid,lymphoid,fibroblasts,endothelial)))

ggplot(pD, aes(x=UMAP1, y=UMAP2, color=MajorGroups)) +
    geom_point()

ggplot(pD, aes(x=UMAP1, y=UMAP2, color=Groups)) +
    geom_point()

library(RColorBrewer)
col.epithelial <- brewer.pal(n=length(epithelial)+1,name="Blues")[2:(length(epithelial)+1)]
names(col.epithelial) <- epithelial

getPalette <- colorRampPalette(brewer.pal(9, "Oranges"))
col.myeloid <- getPalette(length(myeloid)+1)[2:(length(myeloid)+1)]
names(col.myeloid) <- myeloid

col.lymphoid <- brewer.pal(n=length(lymphoid)+1,"Reds")[2:(length(lymphoid)+1)]
names(col.lymphoid) <- lymphoid

getPalette <- colorRampPalette(brewer.pal(9, "Greens"))
col.fibroblasts <- getPalette(length(fibroblasts)+1)[2:(length(fibroblasts)+1)]
names(col.fibroblasts) <- fibroblasts

col.endothelial <- brewer.pal(n=length(endothelial)+1,"Greys")[2:(length(endothelial)+1)]
names(col.endothelial) <- endothelial

colors <- c(col.epithelial, col.myeloid, col.lymphoid, col.fibroblasts,
	    col.endothelial)

pD$Colors <- mapvalues(pD$CellType, names(colors),colors)

test <- pD[sample(nrow(pD)),]
ggplot(test, aes(x=UMAP1, y=UMAP2, color=CellType)) +
    geom_point() +
    scale_color_manual(values=levels(pD$Colors)) 
res <- pD[,c("barcode","FinalCluster","CellType","MajorGroups","Groups","Colors")]
write.csv(res,"../data/Robjects/CellTypes.csv")
```
